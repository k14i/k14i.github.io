<!DOCTYPE html><html lang="ja"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="alternative" href="/atom.xml" title="kt.log" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>Python code for test code generation from Swagger and PlantUML with Azure OpenAI Service - kt.log</title>
<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="/js/fancybox/jquery.fancybox.min.css">
<!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]-->
<script src="/js/jquery-3.1.1.min.js"></script>

<script src="/js/fancybox/jquery.fancybox.min.js"></script>
<meta name="generator" content="Hexo 6.2.0"></head><body style="opacity:0"><header class="head"><h1 class="head-title u-fl"><a href="/">kt.log</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a class="head-nav__link" href="/archives">Articles</a></li><li class="head-nav__item"><a class="head-nav__link" href="/tags">Tags</a></li><li class="head-nav__item"><a class="head-nav__link" href="/links">Links</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"><time class="post__time" datetime="2023-04-12T16:27:13.000Z">2023-04-13 01:27:13</time><h1 class="post__title"><a href="/2023/04/13/Python-code-for-test-code-generation-from-Swagger-and-PlantUML-with-Azure-OpenAI-Service/">Python code for test code generation from Swagger and PlantUML with Azure OpenAI Service</a></h1><div class="post__main echo"><h1 id="Python-ライブラリから-Azure-OpenAI-Service-にリクエストを行い-OpenAPI-と-PlantUML-からテストコードを生成・追加する"><a href="#Python-ライブラリから-Azure-OpenAI-Service-にリクエストを行い-OpenAPI-と-PlantUML-からテストコードを生成・追加する" class="headerlink" title="Python ライブラリから Azure OpenAI Service にリクエストを行い OpenAPI と PlantUML からテストコードを生成・追加する"></a>Python ライブラリから Azure OpenAI Service にリクエストを行い OpenAPI と PlantUML からテストコードを生成・追加する</h1><p>これまで 3 回にわたって、<a target="_blank" rel="noopener" href="https://learn.microsoft.com/ja-jp/azure/cognitive-services/openai/overview">Azure OpenAI Service</a> を使って <a target="_blank" rel="noopener" href="https://www.openapis.org/">OpenAPI 仕様</a> と <a target="_blank" rel="noopener" href="https://plantuml.com/ja/">PlantUML</a> からテストコードを生成する取り組みについての情報共有を行ってきました。</p>
<ol>
<li><a href="/2023/04/06/Test-code-generation-from-Swagger-and-PlantUML-with-Azure-OpenAI-Service/" title="Test code generation from Swagger and PlantUML with Azure OpenAI Service">Test code generation from Swagger and PlantUML with Azure OpenAI Service</a></li>
<li><a href="/2023/04/12/Test-code-generation-from-Swagger-and-PlantUML-with-Azure-OpenAI-Service-using-PromptGenerator-method/" title="Test code generation from Swagger and PlantUML with Azure OpenAI Service using PromptGenerator method">Test code generation from Swagger and PlantUML with Azure OpenAI Service using PromptGenerator method</a></li>
<li><a href="/2023/04/12/Test-code-generation-from-Swagger-and-PlantUML-with-Azure-OpenAI-Service-using-PromptGenerator-method-2/" title="Test code generation from Swagger and PlantUML with Azure OpenAI Service using PromptGenerator method #2">Test code generation from Swagger and PlantUML with Azure OpenAI Service using PromptGenerator method #2</a></li>
</ol>
<p>最終的には、<a target="_blank" rel="noopener" href="https://www.skool.com/chatgpt/promptgenerator?p=1e5ede93">PromptGenerator</a> メソッドを用いて生成したプロンプトを使って GPT-4 でテストコードを生成するのが、最も安定的かつ致命的な間違いの無いコードになることが分かりました。</p>
<p>次はこれを実際の開発業務に適用することを考えると思いますが、Playground を使うというのは、プログラマとして格好悪いですし、<a target="_blank" rel="noopener" href="https://thethreevirtues.com/">三大美徳</a>にも反しますよね。</p>
<p>また、前回 GPT-4 を利用することでテストダブルを正しく使えるようになる (確率が高まる) ことがわかりましたが、一方でテストケースが GPT-3 の場合に比べて減少してしまったという問題が発生しました。</p>
<p>そこで、本記事では <a target="_blank" rel="noopener" href="https://github.com/openai/openai-python">OpenAI Python ライブラリ</a>を使ってテストコードを生成・追加する方法について解説します。</p>
<h2 id="ゴール"><a href="#ゴール" class="headerlink" title="ゴール"></a>ゴール</h2><ul>
<li>テストコードを生成する。</li>
<li>チャットの特徴を利用して、テストケースを追加する。</li>
<li>上記を OpenAI Python Library を使って実行する。</li>
</ul>
<h2 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h2><ul>
<li>API 操作をするプログラミング言語には Python を用います。パッケージ管理には <code>pip</code> または <code>conda</code> がインストールされていることを想定します。</li>
<li>今回、API にはインターネットからアクセスします。(<a target="_blank" rel="noopener" href="https://learn.microsoft.com/ja-jp/azure/cognitive-services/cognitive-services-virtual-networks?context=/azure/cognitive-services/openai/context/context&tabs=portal">仮想ネットワーク</a>は使用しません。)</li>
<li>本記事においては、環境変数に以下の値を格納しておきます。いずれの値も <a target="_blank" rel="noopener" href="https://learn.microsoft.com/ja-jp/azure/azure-portal/azure-portal-overview">Azure Portal</a> における Azure OpenAI リソースから、 <code>[リソース管理] &gt; [キーとエンドポイント]</code> より取得できます。<ul>
<li><code>OPENAI_API_BASE</code><ul>
<li>Azure OpenAI Service のエンドポイントURL。例えば <code>https://my-openai-example-endpoint.openai.azure.com/</code> といった文字列です。</li>
</ul>
</li>
<li><code>OPENAI_API_KEY</code><ul>
<li>Azure OpenAI Service のキー。キー1 または キー2 のいずれかの値を設定します。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="免責"><a href="#免責" class="headerlink" title="免責"></a>免責</h2><ul>
<li>本記事の内容は、執筆時点のものです。LLM の変化やゆらぎもあるため、再現性は保証されません。</li>
<li>本記事の内容は検証レベルのものです。完全な手法に関する情報を提供するものではありません。</li>
<li>本記事で使用する PlantUML は、細部まで作り込んでいるわけではありません。細かい部分で間違いがある可能性があります。</li>
<li>テストケースの追加は、新たなテストクラスを作成する形となっています。本記事執筆時点において、最初に生成されたテストコードのテストクラスの中にテストケースを追加した上ですべてのテストケースを出力する方法については、確立できていません。</li>
</ul>
<h2 id="準備"><a href="#準備" class="headerlink" title="準備"></a>準備</h2><h3 id="ライブラリのインストール"><a href="#ライブラリのインストール" class="headerlink" title="ライブラリのインストール"></a>ライブラリのインストール</h3><p>環境に合わせていずれかを実行してください。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install openai</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conda install openai</span><br></pre></td></tr></table></figure>

<h2 id="Azure-OpenAI-Service-への-API-リクエスト"><a href="#Azure-OpenAI-Service-への-API-リクエスト" class="headerlink" title="Azure OpenAI Service への API リクエスト"></a>Azure OpenAI Service への API リクエスト</h2><p>ステップは以下の通りです。</p>
<ol>
<li>初期化</li>
<li>OpenAPI 仕様 の定義</li>
<li>PlantUML シーケンス図の定義</li>
<li>PlantUML クラス図の定義</li>
<li>インストラクションの定義</li>
<li>テスト対象の定義</li>
<li>各定義からプロンプトを作成</li>
<li>メッセージの作成</li>
<li>リクエストの実行およびレスポンスの取得</li>
</ol>
<h3 id="初期化"><a href="#初期化" class="headerlink" title="初期化"></a>初期化</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> openai</span><br><span class="line">openai.api_type = <span class="string">&quot;azure&quot;</span></span><br><span class="line">openai.api_base = os.getenv(<span class="string">&quot;OPENAI_API_BASE&quot;</span>)</span><br><span class="line">openai.api_version = <span class="string">&quot;2023-03-15-preview&quot;</span></span><br><span class="line">openai.api_key = os.getenv(<span class="string">&quot;OPENAI_API_KEY&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>反復的に実行することを想定し、後で使用する変数も初期化しておきます。(任意)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">messages = []</span><br><span class="line">response = <span class="literal">None</span></span><br><span class="line">pronpt = <span class="literal">None</span></span><br><span class="line">code = <span class="literal">None</span></span><br><span class="line">code_string = <span class="literal">None</span></span><br></pre></td></tr></table></figure>

<h3 id="OpenAPI-仕様-の定義"><a href="#OpenAPI-仕様-の定義" class="headerlink" title="OpenAPI 仕様 の定義"></a>OpenAPI 仕様 の定義</h3><p>これまでと同様、OpenAPI 公式のサンプル “<a target="_blank" rel="noopener" href="https://github.com/OAI/OpenAPI-Specification/blob/main/examples/v2.0/json/petstore-simple.json">petstore-simple.json</a>“ を使用します。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br></pre></td><td class="code"><pre><span class="line">openapi_spec = <span class="string">&#x27;&#x27;&#x27;&#123;</span></span><br><span class="line"><span class="string">  &quot;swagger&quot;: &quot;2.0&quot;,</span></span><br><span class="line"><span class="string">  &quot;info&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;version&quot;: &quot;1.0.0&quot;,</span></span><br><span class="line"><span class="string">    &quot;title&quot;: &quot;Swagger Petstore&quot;,</span></span><br><span class="line"><span class="string">    &quot;description&quot;: &quot;A sample API that uses a petstore as an example to demonstrate features in the swagger-2.0 specification&quot;,</span></span><br><span class="line"><span class="string">    &quot;termsOfService&quot;: &quot;http://swagger.io/terms/&quot;,</span></span><br><span class="line"><span class="string">    &quot;contact&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;name&quot;: &quot;Swagger API Team&quot;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    &quot;license&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;name&quot;: &quot;MIT&quot;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;,</span></span><br><span class="line"><span class="string">  &quot;host&quot;: &quot;petstore.swagger.io&quot;,</span></span><br><span class="line"><span class="string">  &quot;basePath&quot;: &quot;/api&quot;,</span></span><br><span class="line"><span class="string">  &quot;schemes&quot;: [</span></span><br><span class="line"><span class="string">    &quot;http&quot;</span></span><br><span class="line"><span class="string">  ],</span></span><br><span class="line"><span class="string">  &quot;consumes&quot;: [</span></span><br><span class="line"><span class="string">    &quot;application/json&quot;</span></span><br><span class="line"><span class="string">  ],</span></span><br><span class="line"><span class="string">  &quot;produces&quot;: [</span></span><br><span class="line"><span class="string">    &quot;application/json&quot;</span></span><br><span class="line"><span class="string">  ],</span></span><br><span class="line"><span class="string">  &quot;paths&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;/pets&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;get&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;description&quot;: &quot;Returns all pets from the system that the user has access to&quot;,</span></span><br><span class="line"><span class="string">        &quot;operationId&quot;: &quot;findPets&quot;,</span></span><br><span class="line"><span class="string">        &quot;produces&quot;: [</span></span><br><span class="line"><span class="string">          &quot;application/json&quot;,</span></span><br><span class="line"><span class="string">          &quot;application/xml&quot;,</span></span><br><span class="line"><span class="string">          &quot;text/xml&quot;,</span></span><br><span class="line"><span class="string">          &quot;text/html&quot;</span></span><br><span class="line"><span class="string">        ],</span></span><br><span class="line"><span class="string">        &quot;parameters&quot;: [</span></span><br><span class="line"><span class="string">          &#123;</span></span><br><span class="line"><span class="string">            &quot;name&quot;: &quot;tags&quot;,</span></span><br><span class="line"><span class="string">            &quot;in&quot;: &quot;query&quot;,</span></span><br><span class="line"><span class="string">            &quot;description&quot;: &quot;tags to filter by&quot;,</span></span><br><span class="line"><span class="string">            &quot;required&quot;: false,</span></span><br><span class="line"><span class="string">            &quot;type&quot;: &quot;array&quot;,</span></span><br><span class="line"><span class="string">            &quot;items&quot;: &#123;</span></span><br><span class="line"><span class="string">              &quot;type&quot;: &quot;string&quot;</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            &quot;collectionFormat&quot;: &quot;csv&quot;</span></span><br><span class="line"><span class="string">          &#125;,</span></span><br><span class="line"><span class="string">          &#123;</span></span><br><span class="line"><span class="string">            &quot;name&quot;: &quot;limit&quot;,</span></span><br><span class="line"><span class="string">            &quot;in&quot;: &quot;query&quot;,</span></span><br><span class="line"><span class="string">            &quot;description&quot;: &quot;maximum number of results to return&quot;,</span></span><br><span class="line"><span class="string">            &quot;required&quot;: false,</span></span><br><span class="line"><span class="string">            &quot;type&quot;: &quot;integer&quot;,</span></span><br><span class="line"><span class="string">            &quot;format&quot;: &quot;int32&quot;</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        ],</span></span><br><span class="line"><span class="string">        &quot;responses&quot;: &#123;</span></span><br><span class="line"><span class="string">          &quot;200&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;description&quot;: &quot;pet response&quot;,</span></span><br><span class="line"><span class="string">            &quot;schema&quot;: &#123;</span></span><br><span class="line"><span class="string">              &quot;type&quot;: &quot;array&quot;,</span></span><br><span class="line"><span class="string">              &quot;items&quot;: &#123;</span></span><br><span class="line"><span class="string">                &quot;$ref&quot;: &quot;#/definitions/Pet&quot;</span></span><br><span class="line"><span class="string">              &#125;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">          &#125;,</span></span><br><span class="line"><span class="string">          &quot;default&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;description&quot;: &quot;unexpected error&quot;,</span></span><br><span class="line"><span class="string">            &quot;schema&quot;: &#123;</span></span><br><span class="line"><span class="string">              &quot;$ref&quot;: &quot;#/definitions/ErrorModel&quot;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;,</span></span><br><span class="line"><span class="string">      &quot;post&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;description&quot;: &quot;Creates a new pet in the store.  Duplicates are allowed&quot;,</span></span><br><span class="line"><span class="string">        &quot;operationId&quot;: &quot;addPet&quot;,</span></span><br><span class="line"><span class="string">        &quot;produces&quot;: [</span></span><br><span class="line"><span class="string">          &quot;application/json&quot;</span></span><br><span class="line"><span class="string">        ],</span></span><br><span class="line"><span class="string">        &quot;parameters&quot;: [</span></span><br><span class="line"><span class="string">          &#123;</span></span><br><span class="line"><span class="string">            &quot;name&quot;: &quot;pet&quot;,</span></span><br><span class="line"><span class="string">            &quot;in&quot;: &quot;body&quot;,</span></span><br><span class="line"><span class="string">            &quot;description&quot;: &quot;Pet to add to the store&quot;,</span></span><br><span class="line"><span class="string">            &quot;required&quot;: true,</span></span><br><span class="line"><span class="string">            &quot;schema&quot;: &#123;</span></span><br><span class="line"><span class="string">              &quot;$ref&quot;: &quot;#/definitions/NewPet&quot;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        ],</span></span><br><span class="line"><span class="string">        &quot;responses&quot;: &#123;</span></span><br><span class="line"><span class="string">          &quot;200&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;description&quot;: &quot;pet response&quot;,</span></span><br><span class="line"><span class="string">            &quot;schema&quot;: &#123;</span></span><br><span class="line"><span class="string">              &quot;$ref&quot;: &quot;#/definitions/Pet&quot;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">          &#125;,</span></span><br><span class="line"><span class="string">          &quot;default&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;description&quot;: &quot;unexpected error&quot;,</span></span><br><span class="line"><span class="string">            &quot;schema&quot;: &#123;</span></span><br><span class="line"><span class="string">              &quot;$ref&quot;: &quot;#/definitions/ErrorModel&quot;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    &quot;/pets/&#123;id&#125;&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;get&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;description&quot;: &quot;Returns a user based on a single ID, if the user does not have access to the pet&quot;,</span></span><br><span class="line"><span class="string">        &quot;operationId&quot;: &quot;findPetById&quot;,</span></span><br><span class="line"><span class="string">        &quot;produces&quot;: [</span></span><br><span class="line"><span class="string">          &quot;application/json&quot;,</span></span><br><span class="line"><span class="string">          &quot;application/xml&quot;,</span></span><br><span class="line"><span class="string">          &quot;text/xml&quot;,</span></span><br><span class="line"><span class="string">          &quot;text/html&quot;</span></span><br><span class="line"><span class="string">        ],</span></span><br><span class="line"><span class="string">        &quot;parameters&quot;: [</span></span><br><span class="line"><span class="string">          &#123;</span></span><br><span class="line"><span class="string">            &quot;name&quot;: &quot;id&quot;,</span></span><br><span class="line"><span class="string">            &quot;in&quot;: &quot;path&quot;,</span></span><br><span class="line"><span class="string">            &quot;description&quot;: &quot;ID of pet to fetch&quot;,</span></span><br><span class="line"><span class="string">            &quot;required&quot;: true,</span></span><br><span class="line"><span class="string">            &quot;type&quot;: &quot;integer&quot;,</span></span><br><span class="line"><span class="string">            &quot;format&quot;: &quot;int64&quot;</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        ],</span></span><br><span class="line"><span class="string">        &quot;responses&quot;: &#123;</span></span><br><span class="line"><span class="string">          &quot;200&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;description&quot;: &quot;pet response&quot;,</span></span><br><span class="line"><span class="string">            &quot;schema&quot;: &#123;</span></span><br><span class="line"><span class="string">              &quot;$ref&quot;: &quot;#/definitions/Pet&quot;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">          &#125;,</span></span><br><span class="line"><span class="string">          &quot;default&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;description&quot;: &quot;unexpected error&quot;,</span></span><br><span class="line"><span class="string">            &quot;schema&quot;: &#123;</span></span><br><span class="line"><span class="string">              &quot;$ref&quot;: &quot;#/definitions/ErrorModel&quot;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;,</span></span><br><span class="line"><span class="string">      &quot;delete&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;description&quot;: &quot;deletes a single pet based on the ID supplied&quot;,</span></span><br><span class="line"><span class="string">        &quot;operationId&quot;: &quot;deletePet&quot;,</span></span><br><span class="line"><span class="string">        &quot;parameters&quot;: [</span></span><br><span class="line"><span class="string">          &#123;</span></span><br><span class="line"><span class="string">            &quot;name&quot;: &quot;id&quot;,</span></span><br><span class="line"><span class="string">            &quot;in&quot;: &quot;path&quot;,</span></span><br><span class="line"><span class="string">            &quot;description&quot;: &quot;ID of pet to delete&quot;,</span></span><br><span class="line"><span class="string">            &quot;required&quot;: true,</span></span><br><span class="line"><span class="string">            &quot;type&quot;: &quot;integer&quot;,</span></span><br><span class="line"><span class="string">            &quot;format&quot;: &quot;int64&quot;</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        ],</span></span><br><span class="line"><span class="string">        &quot;responses&quot;: &#123;</span></span><br><span class="line"><span class="string">          &quot;204&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;description&quot;: &quot;pet deleted&quot;</span></span><br><span class="line"><span class="string">          &#125;,</span></span><br><span class="line"><span class="string">          &quot;default&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;description&quot;: &quot;unexpected error&quot;,</span></span><br><span class="line"><span class="string">            &quot;schema&quot;: &#123;</span></span><br><span class="line"><span class="string">              &quot;$ref&quot;: &quot;#/definitions/ErrorModel&quot;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;,</span></span><br><span class="line"><span class="string">  &quot;definitions&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;Pet&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;type&quot;: &quot;object&quot;,</span></span><br><span class="line"><span class="string">      &quot;allOf&quot;: [</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">          &quot;$ref&quot;: &quot;#/definitions/NewPet&quot;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">          &quot;required&quot;: [</span></span><br><span class="line"><span class="string">            &quot;id&quot;</span></span><br><span class="line"><span class="string">          ],</span></span><br><span class="line"><span class="string">          &quot;properties&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;id&quot;: &#123;</span></span><br><span class="line"><span class="string">              &quot;type&quot;: &quot;integer&quot;,</span></span><br><span class="line"><span class="string">              &quot;format&quot;: &quot;int64&quot;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      ]</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    &quot;NewPet&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;type&quot;: &quot;object&quot;,</span></span><br><span class="line"><span class="string">      &quot;required&quot;: [</span></span><br><span class="line"><span class="string">        &quot;name&quot;</span></span><br><span class="line"><span class="string">      ],</span></span><br><span class="line"><span class="string">      &quot;properties&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;name&quot;: &#123;</span></span><br><span class="line"><span class="string">          &quot;type&quot;: &quot;string&quot;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &quot;tag&quot;: &#123;</span></span><br><span class="line"><span class="string">          &quot;type&quot;: &quot;string&quot;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    &quot;ErrorModel&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;type&quot;: &quot;object&quot;,</span></span><br><span class="line"><span class="string">      &quot;required&quot;: [</span></span><br><span class="line"><span class="string">        &quot;code&quot;,</span></span><br><span class="line"><span class="string">        &quot;message&quot;</span></span><br><span class="line"><span class="string">      ],</span></span><br><span class="line"><span class="string">      &quot;properties&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;code&quot;: &#123;</span></span><br><span class="line"><span class="string">          &quot;type&quot;: &quot;integer&quot;,</span></span><br><span class="line"><span class="string">          &quot;format&quot;: &quot;int32&quot;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &quot;message&quot;: &#123;</span></span><br><span class="line"><span class="string">          &quot;type&quot;: &quot;string&quot;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="PlantUML-シーケンス図の定義"><a href="#PlantUML-シーケンス図の定義" class="headerlink" title="PlantUML シーケンス図の定義"></a>PlantUML シーケンス図の定義</h3><p>これまでと同様、上記の OpenAPI 仕様に基づいて PlantUML で作成した、簡単なシーケンス図を使用します。<br>描画済みの図に関しては、過去の記事を参照してください。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">plantuml_sequence_diagrams = <span class="string">&#x27;&#x27;&#x27;@startuml</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">title ペット</span></span><br><span class="line"><span class="string">header %page% of %lastpage%</span></span><br><span class="line"><span class="string">footer Copyright(c) All rights reserved.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">autoactivate on</span></span><br><span class="line"><span class="string">autonumber &quot;&lt;b&gt;[00]&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">actor ユーザー as user</span></span><br><span class="line"><span class="string">entity ペットストアUI as ui</span></span><br><span class="line"><span class="string">entity ペットストアAPI as api</span></span><br><span class="line"><span class="string">database データベース as db</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">== ペットのリストを取得 ==</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">user -&gt; ui : ペットリストボタンをクリック</span></span><br><span class="line"><span class="string">ui -&gt; api : findPets</span></span><br><span class="line"><span class="string">api -&gt; db : SELECT * FROM pets</span></span><br><span class="line"><span class="string">return</span></span><br><span class="line"><span class="string">return 200, pet response</span></span><br><span class="line"><span class="string">return ペットのリストを表示</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">== ペットの詳細を取得 ==</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">user -&gt; ui : ペットの詳細ボタンをクリック</span></span><br><span class="line"><span class="string">ui -&gt; api : findPetById</span></span><br><span class="line"><span class="string">api -&gt; db : SELECT * FROM pets WHERE id = $&#123;pet_id&#125;</span></span><br><span class="line"><span class="string">return</span></span><br><span class="line"><span class="string">return 200, pet response</span></span><br><span class="line"><span class="string">return ペットの詳細を表示</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">== ペットを購入 ==</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">user -&gt; ui : ペットの購入ボタンをクリック</span></span><br><span class="line"><span class="string">ui -&gt; api : addPet</span></span><br><span class="line"><span class="string">group transaction</span></span><br><span class="line"><span class="string">    api -&gt; db : transaction</span></span><br><span class="line"><span class="string">    api -&gt; db : INSERT INTO orders VALUES ($&#123;user_id&#125;, $&#123;pet_id&#125;, $&#123;datetime&#125;, $&#123;created_at&#125;, $&#123;updated_at&#125;)</span></span><br><span class="line"><span class="string">    api -&gt; db : DELETE FROM pets WHERE pet_id = $&#123;pet_id&#125;</span></span><br><span class="line"><span class="string">    api -&gt; db : commit</span></span><br><span class="line"><span class="string">    return</span></span><br><span class="line"><span class="string">    return</span></span><br><span class="line"><span class="string">    return</span></span><br><span class="line"><span class="string">    return</span></span><br><span class="line"><span class="string">end</span></span><br><span class="line"><span class="string">return 200, pet response</span></span><br><span class="line"><span class="string">return 購入完了画面を表示</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">== ペットの登録を削除 ==</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">user -&gt; ui : ペットの登録削除ボタンをクリック</span></span><br><span class="line"><span class="string">ui -&gt; api : deletePet</span></span><br><span class="line"><span class="string">group transaction</span></span><br><span class="line"><span class="string">    api -&gt; db : DELETE FROM pets WHERE pet_id = (SELECT id FROM orders WHERE pet_id = $&#123;pet_id&#125; AND user_id = $&#123;user_id&#125;)</span></span><br><span class="line"><span class="string">    api -&gt; db : DELETE FROM orders WHERE pet_id = $&#123;pet_id&#125; AND user_id = $&#123;user_id&#125;</span></span><br><span class="line"><span class="string">    return</span></span><br><span class="line"><span class="string">    return</span></span><br><span class="line"><span class="string">end</span></span><br><span class="line"><span class="string">return 204, pet deleted</span></span><br><span class="line"><span class="string">return 削除完了画面を表示</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">== ペットの購入に失敗 ==</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">user -&gt; ui : ペットの購入ボタンをクリック</span></span><br><span class="line"><span class="string">ui -&gt; api : addPet</span></span><br><span class="line"><span class="string">group transaction</span></span><br><span class="line"><span class="string">    api -&gt; db : transaction</span></span><br><span class="line"><span class="string">    api -&gt; db : INSERT INTO orders VALUES ($&#123;user_id&#125;, $&#123;pet_id&#125;, $&#123;datetime&#125;, $&#123;created_at&#125;, $&#123;updated_at&#125;)</span></span><br><span class="line"><span class="string">    api -&gt; db !! : DELETE FROM pets WHERE pet_id = $&#123;pet_id&#125;</span></span><br><span class="line"><span class="string">    api -&gt; db : rollback</span></span><br><span class="line"><span class="string">    return</span></span><br><span class="line"><span class="string">    return</span></span><br><span class="line"><span class="string">    return</span></span><br><span class="line"><span class="string">end</span></span><br><span class="line"><span class="string">return 500, unexpected error</span></span><br><span class="line"><span class="string">return 購入失敗画面を表示</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">@enduml</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="PlantUML-クラス図の定義"><a href="#PlantUML-クラス図の定義" class="headerlink" title="PlantUML クラス図の定義"></a>PlantUML クラス図の定義</h3><p>これまでと同様、上記の OpenAPI 仕様に基づいて PlantUML で作成した、簡単なクラス図を使用します。<br>描画済みの図に関しては、過去の記事を参照してください。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">plantuml_class_diagrams = <span class="string">&#x27;&#x27;&#x27;@startuml</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">class User &#123;</span></span><br><span class="line"><span class="string">    - id</span></span><br><span class="line"><span class="string">    - name</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">class Pet &#123;</span></span><br><span class="line"><span class="string">    - id</span></span><br><span class="line"><span class="string">    - name</span></span><br><span class="line"><span class="string">    - type</span></span><br><span class="line"><span class="string">    - tag</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">class Order &#123;</span></span><br><span class="line"><span class="string">    - id</span></span><br><span class="line"><span class="string">    - user_id</span></span><br><span class="line"><span class="string">    - pet_id</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Order &quot;1&quot; -- &quot;*&quot; User</span></span><br><span class="line"><span class="string">Order &quot;1&quot; -- &quot;*&quot; Pet</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">@enduml</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="インストラクションの定義"><a href="#インストラクションの定義" class="headerlink" title="インストラクションの定義"></a>インストラクションの定義</h3><p>PromptGenerator メソッドで作成したものです。詳細は過去の記事を参照ください。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">revised_prompt = <span class="string">&#x27;&#x27;&#x27;Generate unit test code in Python using the unittest framework and unittest.mock&#x27;s patch module for given text materials such as OpenAI Specifications (JSON or YAML), PlantUML sequence diagrams (PlantUML format), and PlantUML class diagrams (PlantUML format), following the PEP 8 coding standards.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Key aspects to consider:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">* Aim for more than 90% code coverage, with 100% being preferred.</span></span><br><span class="line"><span class="string">* Consider edge cases and error handling from the given materials step-by-step.</span></span><br><span class="line"><span class="string">* Follow the AAA (Arrange-Act-Assert) style without including comments in the test code.</span></span><br><span class="line"><span class="string">* Generate test cases and prepare test data step-by-step, allowing the user to specify test targets/objectives based on the actors of the sequence diagrams.</span></span><br><span class="line"><span class="string">* Base test cases on class diagrams first, then sequence diagrams, and finally OpenAPI specifications for API servers.</span></span><br><span class="line"><span class="string">* Define immutable test data in the setUp method of the test class that inherits unittest.TestCase, and specify additional test data in test cases if needed.</span></span><br><span class="line"><span class="string">* Use the @patch(&#x27;...&#x27;) decorator for mocking instead of with patch(&#x27;...&#x27;) as mock_foo: statement.</span></span><br><span class="line"><span class="string">* Apply the spy test double pattern using the assert_called_once_with method of patch.object when applicable, and use the with patch.object(&#x27;...&#x27;) as mock_foo: statement in spy test double pattern cases.</span></span><br><span class="line"><span class="string">* Be mindful of token limitations and avoid exceeding them when generating test code.</span></span><br><span class="line"><span class="string">* Never apply test doubles like stub, mock, and the rest for the test targets/objectives.</span></span><br><span class="line"><span class="string">* Ensure that the test code is MECE (mutually exclusive and collectively exhaustive), structured, organized, and clean.</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="テスト対象の定義"><a href="#テスト対象の定義" class="headerlink" title="テスト対象の定義"></a>テスト対象の定義</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">test_target = <span class="string">&quot;ペットストアAPI&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="各定義からプロンプトを作成"><a href="#各定義からプロンプトを作成" class="headerlink" title="各定義からプロンプトを作成"></a>各定義からプロンプトを作成</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">prompt = <span class="string">f&#x27;&#x27;&#x27;/*</span></span><br><span class="line"><span class="string"><span class="subst">&#123;revised_prompt&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">* Test target: <span class="subst">&#123;test_target&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">* OpenAPI Specifications:</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"><span class="subst">&#123;openapi_spec&#125;</span></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">* PlantUML sequence diagrams:</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"><span class="subst">&#123;plantuml_sequence_diagrams&#125;</span></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">* PlantUML class diagrams:</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"><span class="subst">&#123;plantuml_class_diagrams&#125;</span></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">*/</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="メッセージの作成"><a href="#メッセージの作成" class="headerlink" title="メッセージの作成"></a>メッセージの作成</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">messages = [</span><br><span class="line">    &#123;<span class="string">&quot;role&quot;</span>:<span class="string">&quot;system&quot;</span>,<span class="string">&quot;content&quot;</span>:<span class="string">&quot;You are an AI assistant that helps people find information.&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;role&quot;</span>:<span class="string">&quot;user&quot;</span>,<span class="string">&quot;content&quot;</span>:prompt&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h3 id="リクエストの実行およびレスポンスの取得"><a href="#リクエストの実行およびレスポンスの取得" class="headerlink" title="リクエストの実行およびレスポンスの取得"></a>リクエストの実行およびレスポンスの取得</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">response = openai.ChatCompletion.create(</span><br><span class="line">  engine=<span class="string">&quot;gpt-4-32k-0314&quot;</span>,</span><br><span class="line">  messages = messages,</span><br><span class="line">  temperature=<span class="number">0.7</span>,</span><br><span class="line">  max_tokens=<span class="number">1600</span>,</span><br><span class="line">  top_p=<span class="number">0.95</span>,</span><br><span class="line">  frequency_penalty=<span class="number">0</span>,</span><br><span class="line">  presence_penalty=<span class="number">0</span>,</span><br><span class="line">  stop=<span class="literal">None</span>)</span><br></pre></td></tr></table></figure>

<p>以下、パラメータの一覧を作成しましたので、参照してください。</p>
<table>
<thead>
<tr>
<th align="right">#</th>
<th>項目</th>
<th>型</th>
<th>最小値</th>
<th>最大値</th>
<th>説明</th>
</tr>
</thead>
<tbody><tr>
<td align="right">1</td>
<td>engine</td>
<td>str</td>
<td>-</td>
<td>-</td>
<td>Azure OpenAI Service にデプロイしたモデルに付与した名前</td>
</tr>
<tr>
<td align="right">2</td>
<td>messages</td>
<td>list</td>
<td>-</td>
<td>-</td>
<td>ユーザーとAIアシスタントの間で交換されたメッセージのリストです。各メッセージは、{‘role’: ‘system’, ‘content’: ‘…’} 、{‘role’: ‘user’, ‘content’: ‘…’} 、または{‘role’: ‘assistant’, ‘content’: ‘…’} の形式で記述されます。roleは、メッセージの送信者を示し、contentはメッセージの内容を示します。APIは、このメッセージのコンテキストを使用して、適切な応答を生成します。</td>
</tr>
<tr>
<td align="right">3</td>
<td>temperature</td>
<td>float</td>
<td>0</td>
<td>1</td>
<td>生成されるテキストのランダム性を制御します。 温度を下げることは、モデルがより反復的で決定論的な応答を生成することを意味します。 温度を上げると、より予想外または創造的な反応が得られます。 両方ではなく、温度またはトップ P を調整してみてください。</td>
</tr>
<tr>
<td align="right">4</td>
<td>max_tokens</td>
<td>float</td>
<td>1</td>
<td>32768 (※1)</td>
<td>モデル応答ごとのトークン数に制限を設定します。 API は、プロンプト (システム メッセージ、例、メッセージ履歴、およびユーザー クエリを含む) とモデルの応答の間で共有される最大 32768 個のトークンをサポートします。 1 つのトークンは、一般的な英語のテキストで約 4 文字です。この値を低く設定すると、生成されるテキストが短くなります。 (※1)</td>
</tr>
<tr>
<td align="right">5</td>
<td>top_p</td>
<td>float</td>
<td>0</td>
<td>1</td>
<td>生成されるテキストの多様性を制御するために、トークンの選択確率に基づいて使用されるサンプリング手法です。温度と同様に、これはランダム性を制御しますが、別の方法を使用します。 トップ P を下げると、モデルのトークン選択がより可能性の高いトークンに絞り込まれます。 Top P を増やすと、モデルは可能性の高いトークンと低いトークンの両方から選択できるようになります。 両方ではなく、温度またはトップ P を調整してみてください。</td>
</tr>
<tr>
<td align="right">6</td>
<td>frequency_penalty</td>
<td>float</td>
<td>0</td>
<td>2</td>
<td>これまでにテキストに出現した頻度に基づいて、トークンを繰り返す可能性を比例的に減らします。値が高いほど、低頻度のトークンが選択される可能性が低くなります。これにより、応答でまったく同じテキストが繰り返される可能性が低くなります。</td>
</tr>
<tr>
<td align="right">7</td>
<td>presence_penalty</td>
<td>float</td>
<td>0</td>
<td>2</td>
<td>これまでにテキストに登場したトークンを繰り返す可能性を減らします。値が高いほど、繰り返しのペナルティが大きくなります。これにより、応答に新しいトピックが導入される可能性が高くなります。</td>
</tr>
<tr>
<td align="right">8</td>
<td>stop</td>
<td>Optional[list]</td>
<td>-</td>
<td>-</td>
<td>応答の生成を停止する特定の文字列またはシーケンスのリストを指定します。これにより、APIが特定の文字列を検出したときに、その後の生成を停止できます。</td>
</tr>
<tr>
<td align="right">9</td>
<td>n</td>
<td>int</td>
<td>1</td>
<td>N&#x2F;A</td>
<td>APIから返される異なる応答の数を指定します。nを2以上に設定すると、同じ入力に対して複数の異なる応答が返されます。これは、応答の多様性を確保するために役立ちます。</td>
</tr>
<tr>
<td align="right">10</td>
<td>return_prompt</td>
<td>bool</td>
<td>-</td>
<td>-</td>
<td>通常はFalseに設定されていますが、これをTrueに設定すると、APIから返されるJSONレスポンスにプロンプトも含まれます。</td>
</tr>
<tr>
<td align="right">11</td>
<td>echo</td>
<td>bool</td>
<td>-</td>
<td>-</td>
<td>通常はFalseに設定されていますが(※2)、これをTrueに設定すると、APIから返されるJSONレスポンスに入力メッセージも含まれます。</td>
</tr>
<tr>
<td align="right">12</td>
<td>best_of</td>
<td>int</td>
<td>1</td>
<td>20</td>
<td>複数の応答を生成し、すべてのトークンで合計確率が最も高い応答のみを表示します。 未使用の候補には使用コストがかかるため、このパラメーターを慎重に使用し、最大応答長と終了トリガーのパラメーターも設定してください。 ストリーミングは、これが 1 に設定されている場合にのみ機能することに注意してください。best_of の値が大きいほど、APIはより多くの応答を生成して評価しますが、実行時間が長くなる可能性があります。</td>
</tr>
<tr>
<td align="right">13</td>
<td>log_level</td>
<td>str</td>
<td>-</td>
<td>-</td>
<td>APIから返されるログのレベルを指定します。これは、デバッグや問題解決に役立つ情報を取得するために使用できます。 例: debug, info</td>
</tr>
<tr>
<td align="right">14</td>
<td>logprobs</td>
<td>int</td>
<td>0</td>
<td>N&#x2F;A</td>
<td>生成されたテキストのトークンごとに対数確率を取得するために使用されます。たとえば、「logprobs」が 10 の場合、API は最も可能性の高い 10 個のトークンのリストを返します。 「logprobs」が指定されている場合、API は生成されたトークンの logprob を常に返すため、応答には最大で「logprobs+1」要素が含まれる場合があります。この値は、0から設定でき、値が大きいほど、APIから返される対数確率の詳細が増えます。</td>
</tr>
</tbody></table>
<p>※1 gpt-4-32k の場合。</p>
<p>※2 余談ですが、CLI では <code>True</code> がデフォルトになっている点が API と異なります。(ソースコード cli.py L172 参照)</p>
<p>※3 一部に機械翻訳またはGPT-4を使用しています。</p>
<p>※4 もし間違い等あればご指摘ください。</p>
<hr>
<h2 id="レスポンスの処理"><a href="#レスポンスの処理" class="headerlink" title="レスポンスの処理"></a>レスポンスの処理</h2><p>取得したレスポンスを処理し、コードを取り出します。</p>
<p>ステップは以下の通りです。</p>
<ol>
<li>内容の確認 (任意)</li>
<li>コードの取得</li>
</ol>
<h3 id="内容の確認-任意"><a href="#内容の確認-任意" class="headerlink" title="内容の確認 (任意)"></a>内容の確認 (任意)</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(response)</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;choices&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;finish_reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;stop&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Based on the given OpenAPI Specifications and PlantUML diagrams, I have generated the following test code using the unittest framework and unittest.mock&#x27;s patch module:\n\n```python\nimport unittest\nfrom unittest.mock import patch\nfrom petstore_api import PetStoreAPI, Pet, Order\n\n\nclass TestPetStoreAPI(unittest.TestCase):\n    def setUp(self):\n        self.api = PetStoreAPI()\n        self.pets = [\n            Pet(1, \&quot;Dog\&quot;, \&quot;Bulldog\&quot;, \&quot;friendly\&quot;),\n            Pet(2, \&quot;Cat\&quot;, \&quot;Persian\&quot;, \&quot;lazy\&quot;),\n            Pet(3, \&quot;Bird\&quot;, \&quot;Parrot\&quot;, \&quot;talkative\&quot;)\n        ]\n        self.orders = [\n            Order(1, 1, 1),\n            Order(2, 2, 2)\n        ]\n\n    @patch(&#x27;petstore_api.PetStoreAPI._get_pets_from_db&#x27;)\n    def test_find_pets(self, mock_get_pets_from_db):\n        mock_get_pets_from_db.return_value = self.pets\n        result = self.api.find_pets()\n        self.assertEqual(result, self.pets)\n        mock_get_pets_from_db.assert_called_once_with()\n\n    @patch(&#x27;petstore_api.PetStoreAPI._get_pet_from_db_by_id&#x27;)\n    def test_find_pet_by_id(self, mock_get_pet_from_db_by_id):\n        pet_id = 1\n        mock_get_pet_from_db_by_id.return_value = self.pets[0]\n        result = self.api.find_pet_by_id(pet_id)\n        self.assertEqual(result, self.pets[0])\n        mock_get_pet_from_db_by_id.assert_called_once_with(pet_id)\n\n    @patch(&#x27;petstore_api.PetStoreAPI._delete_pet_from_db&#x27;)\n    @patch(&#x27;petstore_api.PetStoreAPI._delete_order_from_db&#x27;)\n    def test_delete_pet(self, mock_delete_order_from_db, mock_delete_pet_from_db):\n        pet_id = 1\n        user_id = 1\n        self.api.delete_pet(pet_id, user_id)\n        mock_delete_order_from_db.assert_called_once_with(pet_id, user_id)\n        mock_delete_pet_from_db.assert_called_once_with(pet_id)\n\n    @patch(&#x27;petstore_api.PetStoreAPI._add_pet_to_db&#x27;)\n    @patch(&#x27;petstore_api.PetStoreAPI._create_order_in_db&#x27;)\n    def test_add_pet(self, mock_create_order_in_db, mock_add_pet_to_db):\n        user_id = 3\n        pet_id = 3\n        mock_create_order_in_db.return_value = Order(3, user_id, pet_id)\n        mock_add_pet_to_db.return_value = self.pets[2]\n        result = self.api.add_pet(user_id, pet_id)\n        self.assertEqual(result, self.pets[2])\n        mock_create_order_in_db.assert_called_once_with(user_id, pet_id)\n        mock_add_pet_to_db.assert_called_once_with(pet_id)\n\n\nif __name__ == &#x27;__main__&#x27;:\n    unittest.main()\n```\n\nNote that this test code assumes the existence of a `petstore_api` module that implements the `PetStoreAPI`, `Pet`, and `Order` classes, as well as their corresponding database access methods. Please make sure to implement these classes and methods in your application for the tests to work correctly.&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;role&quot;</span><span class="punctuation">:</span> <span class="string">&quot;assistant&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;created&quot;</span><span class="punctuation">:</span> <span class="number">1681315820</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;chatcmpl-*****************************&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;model&quot;</span><span class="punctuation">:</span> <span class="string">&quot;gpt-4-32k&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;object&quot;</span><span class="punctuation">:</span> <span class="string">&quot;chat.completion&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;usage&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;completion_tokens&quot;</span><span class="punctuation">:</span> <span class="number">680</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;prompt_tokens&quot;</span><span class="punctuation">:</span> <span class="number">2278</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;total_tokens&quot;</span><span class="punctuation">:</span> <span class="number">2958</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="コードの取得"><a href="#コードの取得" class="headerlink" title="コードの取得"></a>コードの取得</h3><p>正規表現を使うと処理時間が長くなるため、通常の文字列の処理を採用しました。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">code = response.choices[<span class="number">0</span>].message.content.split(<span class="string">&#x27;```&#x27;</span>)[<span class="number">1</span>].lstrip(<span class="string">&#x27;python\n&#x27;</span>)</span><br><span class="line">code_string = <span class="string">f&#x27;&#x27;&#x27;<span class="subst">&#123;code&#125;</span>&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(code)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> unittest</span><br><span class="line"><span class="keyword">from</span> unittest.mock <span class="keyword">import</span> patch</span><br><span class="line"><span class="keyword">from</span> petstore_api <span class="keyword">import</span> PetStoreAPI, Pet, Order</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TestPetStoreAPI</span>(unittest.TestCase):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setUp</span>(<span class="params">self</span>):</span><br><span class="line">        self.api = PetStoreAPI()</span><br><span class="line">        self.pets = [</span><br><span class="line">            Pet(<span class="number">1</span>, <span class="string">&quot;Dog&quot;</span>, <span class="string">&quot;Bulldog&quot;</span>, <span class="string">&quot;friendly&quot;</span>),</span><br><span class="line">            Pet(<span class="number">2</span>, <span class="string">&quot;Cat&quot;</span>, <span class="string">&quot;Persian&quot;</span>, <span class="string">&quot;lazy&quot;</span>),</span><br><span class="line">            Pet(<span class="number">3</span>, <span class="string">&quot;Bird&quot;</span>, <span class="string">&quot;Parrot&quot;</span>, <span class="string">&quot;talkative&quot;</span>)</span><br><span class="line">        ]</span><br><span class="line">        self.orders = [</span><br><span class="line">            Order(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line">            Order(<span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>)</span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&#x27;petstore_api.PetStoreAPI._get_pets_from_db&#x27;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_find_pets</span>(<span class="params">self, mock_get_pets_from_db</span>):</span><br><span class="line">        mock_get_pets_from_db.return_value = self.pets</span><br><span class="line">        result = self.api.find_pets()</span><br><span class="line">        self.assertEqual(result, self.pets)</span><br><span class="line">        mock_get_pets_from_db.assert_called_once_with()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&#x27;petstore_api.PetStoreAPI._get_pet_from_db_by_id&#x27;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_find_pet_by_id</span>(<span class="params">self, mock_get_pet_from_db_by_id</span>):</span><br><span class="line">        pet_id = <span class="number">1</span></span><br><span class="line">        mock_get_pet_from_db_by_id.return_value = self.pets[<span class="number">0</span>]</span><br><span class="line">        result = self.api.find_pet_by_id(pet_id)</span><br><span class="line">        self.assertEqual(result, self.pets[<span class="number">0</span>])</span><br><span class="line">        mock_get_pet_from_db_by_id.assert_called_once_with(pet_id)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&#x27;petstore_api.PetStoreAPI._delete_pet_from_db&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&#x27;petstore_api.PetStoreAPI._delete_order_from_db&#x27;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_delete_pet</span>(<span class="params">self, mock_delete_order_from_db, mock_delete_pet_from_db</span>):</span><br><span class="line">        pet_id = <span class="number">1</span></span><br><span class="line">        user_id = <span class="number">1</span></span><br><span class="line">        self.api.delete_pet(pet_id, user_id)</span><br><span class="line">        mock_delete_order_from_db.assert_called_once_with(pet_id, user_id)</span><br><span class="line">        mock_delete_pet_from_db.assert_called_once_with(pet_id)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&#x27;petstore_api.PetStoreAPI._add_pet_to_db&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&#x27;petstore_api.PetStoreAPI._create_order_in_db&#x27;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_add_pet</span>(<span class="params">self, mock_create_order_in_db, mock_add_pet_to_db</span>):</span><br><span class="line">        user_id = <span class="number">3</span></span><br><span class="line">        pet_id = <span class="number">3</span></span><br><span class="line">        mock_create_order_in_db.return_value = Order(<span class="number">3</span>, user_id, pet_id)</span><br><span class="line">        mock_add_pet_to_db.return_value = self.pets[<span class="number">2</span>]</span><br><span class="line">        result = self.api.add_pet(user_id, pet_id)</span><br><span class="line">        self.assertEqual(result, self.pets[<span class="number">2</span>])</span><br><span class="line">        mock_create_order_in_db.assert_called_once_with(user_id, pet_id)</span><br><span class="line">        mock_add_pet_to_db.assert_called_once_with(pet_id)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    unittest.main()</span><br></pre></td></tr></table></figure>


<hr>
<h2 id="追加のリクエスト"><a href="#追加のリクエスト" class="headerlink" title="追加のリクエスト"></a>追加のリクエスト</h2><p>先のリクエスト・レスポンスのコンテキストを引き継いだまま、続けてリクエストを行います。</p>
<p>ステップは以下の通りです。</p>
<ol>
<li>メッセージの更新</li>
<li>リクエストの実行およびレスポンスの取得</li>
<li>レスポンス内容の確認 (任意)</li>
<li>コードの取得</li>
</ol>
<h3 id="メッセージの更新"><a href="#メッセージの更新" class="headerlink" title="メッセージの更新"></a>メッセージの更新</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">messages.append(response.choices[<span class="number">0</span>].message)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">prompt = <span class="string">&quot;I would like you to add test cases of transaction failure on delete_pet. You should change the test class name to be different from existing test class names.&quot;</span></span><br><span class="line"></span><br><span class="line">messages.append(&#123;<span class="string">&quot;role&quot;</span>:<span class="string">&quot;user&quot;</span>,<span class="string">&quot;content&quot;</span>:prompt&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="リクエストの実行およびレスポンスの取得-1"><a href="#リクエストの実行およびレスポンスの取得-1" class="headerlink" title="リクエストの実行およびレスポンスの取得"></a>リクエストの実行およびレスポンスの取得</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">response = openai.ChatCompletion.create(</span><br><span class="line">  engine=<span class="string">&quot;gpt-4-32k-0314&quot;</span>,</span><br><span class="line">  messages = messages,</span><br><span class="line">  temperature=<span class="number">0.7</span>,</span><br><span class="line">  max_tokens=<span class="number">1600</span>,</span><br><span class="line">  top_p=<span class="number">0.95</span>,</span><br><span class="line">  frequency_penalty=<span class="number">0</span>,</span><br><span class="line">  presence_penalty=<span class="number">0</span>,</span><br><span class="line">  stop=<span class="literal">None</span>)</span><br></pre></td></tr></table></figure>

<h3 id="レスポンス内容の確認-任意"><a href="#レスポンス内容の確認-任意" class="headerlink" title="レスポンス内容の確認 (任意)"></a>レスポンス内容の確認 (任意)</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(response)</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;choices&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;finish_reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;stop&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="string">&quot;I have added a new test class named `TestPetStoreAPITransactionFailures` with test cases for transaction failure on `delete_pet`. The existing test cases are preserved in the `TestPetStoreAPI` class.\n\n```python\nimport unittest\nfrom unittest.mock import patch\nfrom petstore_api import PetStoreAPI, Pet, Order\n\n\nclass TestPetStoreAPI(unittest.TestCase):\n    # ... (previous test cases)\n\n    # Add any new test cases for the existing class here\n\n\nclass TestPetStoreAPITransactionFailures(unittest.TestCase):\n    def setUp(self):\n        self.api = PetStoreAPI()\n        self.pets = [\n            Pet(1, \&quot;Dog\&quot;, \&quot;Bulldog\&quot;, \&quot;friendly\&quot;),\n            Pet(2, \&quot;Cat\&quot;, \&quot;Persian\&quot;, \&quot;lazy\&quot;),\n            Pet(3, \&quot;Bird\&quot;, \&quot;Parrot\&quot;, \&quot;talkative\&quot;)\n        ]\n        self.orders = [\n            Order(1, 1, 1),\n            Order(2, 2, 2)\n        ]\n\n    @patch(&#x27;petstore_api.PetStoreAPI._delete_pet_from_db&#x27;)\n    @patch(&#x27;petstore_api.PetStoreAPI._delete_order_from_db&#x27;)\n    def test_delete_pet_transaction_failure(self, mock_delete_order_from_db, mock_delete_pet_from_db):\n        pet_id = 1\n        user_id = 1\n        mock_delete_order_from_db.side_effect = Exception(\&quot;Transaction failure\&quot;)\n\n        with self.assertRaises(Exception) as context:\n            self.api.delete_pet(pet_id, user_id)\n\n        self.assertEqual(str(context.exception), \&quot;Transaction failure\&quot;)\n        mock_delete_order_from_db.assert_called_once_with(pet_id, user_id)\n        mock_delete_pet_from_db.assert_not_called()\n\n\nif __name__ == &#x27;__main__&#x27;:\n    unittest.main()\n```\n\nThe new test class `TestPetStoreAPITransactionFailures` contains a test case for transaction failure on `delete_pet`. The test case uses the `side_effect` attribute of the mock object to simulate an exception during the transaction, and the test verifies that the exception is raised and the `_delete_pet_from_db` method is not called.&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;role&quot;</span><span class="punctuation">:</span> <span class="string">&quot;assistant&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;created&quot;</span><span class="punctuation">:</span> <span class="number">1681350212</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;chatcmpl-*****************************&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;model&quot;</span><span class="punctuation">:</span> <span class="string">&quot;gpt-4-32k&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;object&quot;</span><span class="punctuation">:</span> <span class="string">&quot;chat.completion&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;usage&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;completion_tokens&quot;</span><span class="punctuation">:</span> <span class="number">439</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;prompt_tokens&quot;</span><span class="punctuation">:</span> <span class="number">3073</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;total_tokens&quot;</span><span class="punctuation">:</span> <span class="number">3512</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="コードの取得-1"><a href="#コードの取得-1" class="headerlink" title="コードの取得"></a>コードの取得</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">code = response.choices[<span class="number">0</span>].message.content.split(<span class="string">&#x27;```&#x27;</span>)[<span class="number">1</span>].lstrip(<span class="string">&#x27;python\n&#x27;</span>)</span><br><span class="line">code_string = <span class="string">f&#x27;&#x27;&#x27;<span class="subst">&#123;code&#125;</span>&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(code_string)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> unittest</span><br><span class="line"><span class="keyword">from</span> unittest.mock <span class="keyword">import</span> patch</span><br><span class="line"><span class="keyword">from</span> petstore_api <span class="keyword">import</span> PetStoreAPI, Pet, Order</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TestPetStoreAPI</span>(unittest.TestCase):</span><br><span class="line">    <span class="comment"># ... (previous test cases)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Add any new test cases for the existing class here</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TestPetStoreAPITransactionFailures</span>(unittest.TestCase):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setUp</span>(<span class="params">self</span>):</span><br><span class="line">        self.api = PetStoreAPI()</span><br><span class="line">        self.pets = [</span><br><span class="line">            Pet(<span class="number">1</span>, <span class="string">&quot;Dog&quot;</span>, <span class="string">&quot;Bulldog&quot;</span>, <span class="string">&quot;friendly&quot;</span>),</span><br><span class="line">            Pet(<span class="number">2</span>, <span class="string">&quot;Cat&quot;</span>, <span class="string">&quot;Persian&quot;</span>, <span class="string">&quot;lazy&quot;</span>),</span><br><span class="line">            Pet(<span class="number">3</span>, <span class="string">&quot;Bird&quot;</span>, <span class="string">&quot;Parrot&quot;</span>, <span class="string">&quot;talkative&quot;</span>)</span><br><span class="line">        ]</span><br><span class="line">        self.orders = [</span><br><span class="line">            Order(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line">            Order(<span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>)</span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&#x27;petstore_api.PetStoreAPI._delete_pet_from_db&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&#x27;petstore_api.PetStoreAPI._delete_order_from_db&#x27;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_delete_pet_transaction_failure</span>(<span class="params">self, mock_delete_order_from_db, mock_delete_pet_from_db</span>):</span><br><span class="line">        pet_id = <span class="number">1</span></span><br><span class="line">        user_id = <span class="number">1</span></span><br><span class="line">        mock_delete_order_from_db.side_effect = Exception(<span class="string">&quot;Transaction failure&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> self.assertRaises(Exception) <span class="keyword">as</span> context:</span><br><span class="line">            self.api.delete_pet(pet_id, user_id)</span><br><span class="line"></span><br><span class="line">        self.assertEqual(<span class="built_in">str</span>(context.exception), <span class="string">&quot;Transaction failure&quot;</span>)</span><br><span class="line">        mock_delete_order_from_db.assert_called_once_with(pet_id, user_id)</span><br><span class="line">        mock_delete_pet_from_db.assert_not_called()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    unittest.main()</span><br></pre></td></tr></table></figure>

<p>以前のコンテキストを引き継いだまま、追加のリクエスト通りにコードを取得することができました。</p>
<hr>
<h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>Azure OpenAI Service について、 Python ライブラリを使ってテストコードを生成・追加する方法について解説しました。</p>
<p>プログラマブルな点、すなわち <code>openai.ChatCompletion.create</code> で多彩なパラメータが指定できたり、<code>messages</code> のリストを操作することができる点、また、少なくともリクエストに関しては再現性を持たせられる点が、 Playground に対する大きなメリットです。</p>
<p>また、この取り組みについて反復的な検証をする際に、Jupyter Notebook を利用して効率的に行うことができます。</p>
<p>実装自体は上記の通り簡単にできますので、ぜひトライしてみてください。</p>
</div></header><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a class="post__tag__link" href="/tags/Azure/">Azure</a></li><li class="post__tag__item"><a class="post__tag__link" href="/tags/Azure-OpenAI-Service/">Azure OpenAI Service</a></li><li class="post__tag__item"><a class="post__tag__link" href="/tags/OpenAPI/">OpenAPI</a></li><li class="post__tag__item"><a class="post__tag__link" href="/tags/PlantUML/">PlantUML</a></li><li class="post__tag__item"><a class="post__tag__link" href="/tags/TDD/">TDD</a></li><li class="post__tag__item"><a class="post__tag__link" href="/tags/GPT-4/">GPT-4</a></li><li class="post__tag__item"><a class="post__tag__link" href="/tags/OpenAI/">OpenAI</a></li></ul></footer></article></main><footer class="foot"><div class="foot-copy">&copy; 2021 - 2023 kt.log<a class="icp-a" href="https://github.com/k14i" target="view_window">by kt (Keisuke Takahashi)</a></div></footer><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
ga('create','G-9XBBR7M7V2');
ga('send','pageview');</script>
<script src="/js/scroller.js"></script>

<script src="/js/main.js"></script>
</body></html>