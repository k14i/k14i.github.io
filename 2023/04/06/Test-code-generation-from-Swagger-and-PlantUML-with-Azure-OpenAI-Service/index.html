<!DOCTYPE html><html lang="ja"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="alternative" href="/atom.xml" title="kt.log" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>Test code generation from Swagger and PlantUML with Azure OpenAI Service - kt.log</title>
<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="/js/fancybox/jquery.fancybox.min.css">
<!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]-->
<script src="/js/jquery-3.1.1.min.js"></script>

<script src="/js/fancybox/jquery.fancybox.min.js"></script>
<meta name="generator" content="Hexo 6.2.0"></head><body style="opacity:0"><header class="head"><h1 class="head-title u-fl"><a href="/">kt.log</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a class="head-nav__link" href="/archives">Articles</a></li><li class="head-nav__item"><a class="head-nav__link" href="/tags">Tags</a></li><li class="head-nav__item"><a class="head-nav__link" href="/links">Links</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"><time class="post__time" datetime="2023-04-06T07:45:22.000Z">2023-04-06 16:45:22</time><h1 class="post__title"><a href="/2023/04/06/Test-code-generation-from-Swagger-and-PlantUML-with-Azure-OpenAI-Service/">Test code generation from Swagger and PlantUML with Azure OpenAI Service</a></h1><div class="post__main echo"><h1 id="Azure-OpenAI-Service-を使って-OpenAPI-と-PlantUML-からテストコードを生成する"><a href="#Azure-OpenAI-Service-を使って-OpenAPI-と-PlantUML-からテストコードを生成する" class="headerlink" title="Azure OpenAI Service を使って OpenAPI と PlantUML からテストコードを生成する"></a>Azure OpenAI Service を使って OpenAPI と PlantUML からテストコードを生成する</h1><p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/semantic-kernel/concepts-ai/">LLM (大規模言語モデル)</a> を使ったコード生成の文脈において、<a target="_blank" rel="noopener" href="https://thethreevirtues.com/">「怠惰」で「短気」で「傲慢」</a>な職業プログラマがまず到達したいのは、テストコードの自動生成と、そのすべてのテストケースをパスする実装コードの生成だと思います。<br>本記事ではテストコードの自動生成について、取り組みを紹介します。</p>
<p>本取り組みでは、テストコードを生成するためのプロンプトの一部として、<a target="_blank" rel="noopener" href="https://www.openapis.org/">OpenAPI 仕様</a> と <a target="_blank" rel="noopener" href="https://plantuml.com/ja/">PlantUML</a> を使用します。<br>実装コードではなくまずテストコードの生成を試みる理由は、<a target="_blank" rel="noopener" href="https://ja.wikipedia.org/wiki/%E3%83%86%E3%82%B9%E3%83%88%E9%A7%86%E5%8B%95%E9%96%8B%E7%99%BA">テスト駆動開発</a> のアプローチを取るためです。<br>もちろん我々がテストコードを書いて、それをもとに実装コードを生成するというアプローチもあると思いますが、それは別の取り組みとして検証・評価したいと思います。</p>
<h2 id="ゴール"><a href="#ゴール" class="headerlink" title="ゴール"></a>ゴール</h2><ul>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/ja-jp/azure/cognitive-services/openai/overview">Azure OpenAI Service</a> を使ってドキュメントからテストコードを生成し、その内容を評価する。</li>
</ul>
<h2 id="免責"><a href="#免責" class="headerlink" title="免責"></a>免責</h2><ul>
<li>本記事の内容は、執筆時点のものです。LLM の変化やゆらぎもあるため、再現性は保証されません。</li>
<li>本記事の内容は検証レベルのものです。完全な手法に関する情報を提供するものではありません。</li>
<li>本記事で使用する PlantUML は、細部まで作り込んでいるわけではありません。細かい部分で間違いがある可能性があります。</li>
<li>本記事で使用されるプロンプトは、特に突き詰めてチューニングを行っているわけではありません。</li>
</ul>
<h2 id="準備"><a href="#準備" class="headerlink" title="準備"></a>準備</h2><h3 id="OpenAPI-仕様"><a href="#OpenAPI-仕様" class="headerlink" title="OpenAPI 仕様"></a>OpenAPI 仕様</h3><p>本記事では OpenAPI 公式のサンプル “<a target="_blank" rel="noopener" href="https://github.com/OAI/OpenAPI-Specification/blob/main/examples/v2.0/json/petstore-simple.json">petstore-simple.json</a>“ を使用します。<br>以下に転記します。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;swagger&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;info&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Swagger Petstore&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A sample API that uses a petstore as an example to demonstrate features in the swagger-2.0 specification&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;termsOfService&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://swagger.io/terms/&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;contact&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Swagger API Team&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;license&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MIT&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;petstore.swagger.io&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;basePath&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/api&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;schemes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;http&quot;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;consumes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;application/json&quot;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;produces&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;application/json&quot;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;paths&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;/pets&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;get&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Returns all pets from the system that the user has access to&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;operationId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;findPets&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;produces&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;application/json&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="string">&quot;application/xml&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="string">&quot;text/xml&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="string">&quot;text/html&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;parameters&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tags&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;in&quot;</span><span class="punctuation">:</span> <span class="string">&quot;query&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tags to filter by&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;required&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;array&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;items&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;collectionFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;csv&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;limit&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;in&quot;</span><span class="punctuation">:</span> <span class="string">&quot;query&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;maximum number of results to return&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;required&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;int32&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;responses&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;200&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pet response&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;schema&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;array&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;items&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;#/definitions/Pet&quot;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;default&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;unexpected error&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;schema&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;#/definitions/ErrorModel&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;post&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Creates a new pet in the store.  Duplicates are allowed&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;operationId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;addPet&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;produces&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;application/json&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;parameters&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pet&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;in&quot;</span><span class="punctuation">:</span> <span class="string">&quot;body&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Pet to add to the store&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;required&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;schema&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;#/definitions/NewPet&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;responses&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;200&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pet response&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;schema&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;#/definitions/Pet&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;default&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;unexpected error&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;schema&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;#/definitions/ErrorModel&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;/pets/&#123;id&#125;&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;get&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Returns a user based on a single ID, if the user does not have access to the pet&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;operationId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;findPetById&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;produces&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;application/json&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="string">&quot;application/xml&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="string">&quot;text/xml&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="string">&quot;text/html&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;parameters&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;id&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;in&quot;</span><span class="punctuation">:</span> <span class="string">&quot;path&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ID of pet to fetch&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;required&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;int64&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;responses&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;200&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pet response&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;schema&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;#/definitions/Pet&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;default&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;unexpected error&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;schema&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;#/definitions/ErrorModel&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;delete&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;deletes a single pet based on the ID supplied&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;operationId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;deletePet&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;parameters&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;id&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;in&quot;</span><span class="punctuation">:</span> <span class="string">&quot;path&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ID of pet to delete&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;required&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;int64&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;responses&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;204&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pet deleted&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;default&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;unexpected error&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;schema&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;#/definitions/ErrorModel&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;definitions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Pet&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;allOf&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;#/definitions/NewPet&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;required&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;id&quot;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;int64&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;NewPet&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;required&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;name&quot;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ErrorModel&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;required&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;code&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;message&quot;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;int32&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>


<h3 id="PlantUML-のシーケンス図"><a href="#PlantUML-のシーケンス図" class="headerlink" title="PlantUML のシーケンス図"></a>PlantUML のシーケンス図</h3><p>上記の OpenAPI 仕様に基づき、簡単なシーケンス図を PlantUML で作成しました。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">@startuml</span><br><span class="line"></span><br><span class="line">title ペット</span><br><span class="line">header %page% of %lastpage%</span><br><span class="line">footer Copyright(c) All rights reserved.</span><br><span class="line"></span><br><span class="line">autoactivate on</span><br><span class="line">autonumber &quot;&lt;b&gt;[00]&quot;</span><br><span class="line"></span><br><span class="line">actor ユーザー as user</span><br><span class="line">entity ペットストアUI as ui</span><br><span class="line">entity ペットストアAPI as api</span><br><span class="line">database データベース as db</span><br><span class="line"></span><br><span class="line">== ペットのリストを取得 ==</span><br><span class="line"></span><br><span class="line">user -&gt; ui : ペットリストボタンをクリック</span><br><span class="line">ui -&gt; api : findPets</span><br><span class="line">api -&gt; db : SELECT * FROM pets</span><br><span class="line">return</span><br><span class="line">return 200, pet response</span><br><span class="line">return ペットのリストを表示</span><br><span class="line"></span><br><span class="line">== ペットの詳細を取得 ==</span><br><span class="line"></span><br><span class="line">user -&gt; ui : ペットの詳細ボタンをクリック</span><br><span class="line">ui -&gt; api : findPetById</span><br><span class="line">api -&gt; db : SELECT * FROM pets WHERE id = $&#123;pet_id&#125;</span><br><span class="line">return</span><br><span class="line">return 200, pet response</span><br><span class="line">return ペットの詳細を表示</span><br><span class="line"></span><br><span class="line">== ペットを購入 ==</span><br><span class="line"></span><br><span class="line">user -&gt; ui : ペットの購入ボタンをクリック</span><br><span class="line">ui -&gt; api : addPet</span><br><span class="line">group transaction</span><br><span class="line">    api -&gt; db : transaction</span><br><span class="line">    api -&gt; db : INSERT INTO orders VALUES ($&#123;user_id&#125;, $&#123;pet_id&#125;, $&#123;datetime&#125;, $&#123;created_at&#125;, $&#123;updated_at&#125;)</span><br><span class="line">    api -&gt; db : DELETE FROM pets WHERE pet_id = $&#123;pet_id&#125;</span><br><span class="line">    api -&gt; db : commit</span><br><span class="line">    return</span><br><span class="line">    return</span><br><span class="line">    return</span><br><span class="line">    return</span><br><span class="line">end</span><br><span class="line">return 200, pet response</span><br><span class="line">return 購入完了画面を表示</span><br><span class="line"></span><br><span class="line">== ペットの登録を削除 ==</span><br><span class="line"></span><br><span class="line">user -&gt; ui : ペットの登録削除ボタンをクリック</span><br><span class="line">ui -&gt; api : deletePet</span><br><span class="line">group transaction</span><br><span class="line">    api -&gt; db : DELETE FROM pets WHERE pet_id = (SELECT id FROM orders WHERE pet_id = $&#123;pet_id&#125; AND user_id = $&#123;user_id&#125;)</span><br><span class="line">    api -&gt; db : DELETE FROM orders WHERE pet_id = $&#123;pet_id&#125; AND user_id = $&#123;user_id&#125;</span><br><span class="line">    return</span><br><span class="line">    return</span><br><span class="line">end</span><br><span class="line">return 204, pet deleted</span><br><span class="line">return 削除完了画面を表示</span><br><span class="line"></span><br><span class="line">== ペットの購入に失敗 ==</span><br><span class="line"></span><br><span class="line">user -&gt; ui : ペットの購入ボタンをクリック</span><br><span class="line">ui -&gt; api : addPet</span><br><span class="line">group transaction</span><br><span class="line">    api -&gt; db : transaction</span><br><span class="line">    api -&gt; db : INSERT INTO orders VALUES ($&#123;user_id&#125;, $&#123;pet_id&#125;, $&#123;datetime&#125;, $&#123;created_at&#125;, $&#123;updated_at&#125;)</span><br><span class="line">    api -&gt; db !! : DELETE FROM pets WHERE pet_id = $&#123;pet_id&#125;</span><br><span class="line">    api -&gt; db : rollback</span><br><span class="line">    return</span><br><span class="line">    return</span><br><span class="line">    return</span><br><span class="line">end</span><br><span class="line">return 500, unexpected error</span><br><span class="line">return 購入失敗画面を表示</span><br><span class="line"></span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>

<p>シーケンス図の画像は以下の通りです。</p>
<img src="/2023/04/06/Test-code-generation-from-Swagger-and-PlantUML-with-Azure-OpenAI-Service/Test-code-generation-from-Swagger-and-PlantUML-with-Azure-OpenAI-Service-Sequence-Diagram.png" class="slug">

<h3 id="PlantUML-のクラス図"><a href="#PlantUML-のクラス図" class="headerlink" title="PlantUML のクラス図"></a>PlantUML のクラス図</h3><p>同様に、今回使用する OpenAPI 仕様に基づき、PlantUML で簡単なクラス図を作成しました。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">@startuml</span><br><span class="line"></span><br><span class="line">class User &#123;</span><br><span class="line">    - id</span><br><span class="line">    - name</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Pet &#123;</span><br><span class="line">    - id</span><br><span class="line">    - name</span><br><span class="line">    - type</span><br><span class="line">    - tag</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Order &#123;</span><br><span class="line">    - id</span><br><span class="line">    - user_id</span><br><span class="line">    - pet_id</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Order &quot;1&quot; -- &quot;*&quot; User</span><br><span class="line">Order &quot;1&quot; -- &quot;*&quot; Pet</span><br><span class="line"></span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>

<p>クラス図の画像は以下の通りです。</p>
<img src="/2023/04/06/Test-code-generation-from-Swagger-and-PlantUML-with-Azure-OpenAI-Service/Test-code-generation-from-Swagger-and-PlantUML-with-Azure-OpenAI-Service-Class-Diagram.png" class="slug">

<h3 id="プロンプト"><a href="#プロンプト" class="headerlink" title="プロンプト"></a>プロンプト</h3><p>プロンプトは以下の通りです。免責にある通り、チューニングは特にしていません。適当に作文したものです。<br>日本語でも良いのですが、意図がより正しく伝わるよう、英語で作文しています。</p>
<p>非常に長くなってしまうため、上記の 3点については、ここでは記述を省略しています。後で別途 <code># NOTE: ここに〜を入れる</code> と書いてある箇所にコピペをして、プロンプトを完成させます。</p>
<p>なお、本記事では Python を指定しています。簡単な修正を行うことで他の言語にも対応可能です。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">You are a professional programmer.</span><br><span class="line">Please create test codes in Python by importing unittest module along with the REST API definition written in Swagger, the sequence diagram in PlantUML, and the class diagram in PlantUML below:</span><br><span class="line"></span><br><span class="line">The REST API definition written in Swagger</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"># NOTE: ここに OpenAPI 仕様を入れる</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">The sequence diagram in PlantUML</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"># NOTE: ここに PlantUML のシーケンス図を入れる</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">The class diagram in PlantUML</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"># NOTE: ここに PlantUML のクラス図を入れる</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">To give me a solution, you can consider that step-by-step.</span><br><span class="line">Assume the usages of the objects.</span><br><span class="line">Prepare test data, test doubles such as stubs, mocks, dummies, spies, and the rest, and test cases for meaningful test codes.</span><br><span class="line">You can use `from unittest.mock import patch` to use mocks.</span><br><span class="line">*/</span><br></pre></td></tr></table></figure>

<p>参考までに、和訳を以下に掲載します。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">あなたはプロのプログラマーです。</span><br><span class="line">以下の Swagger で記述された REST API 定義、PlantUML でのシーケンス図、PlantUML でのクラス図に沿って、 unittest モジュールをインポートして Python でテスト コードを作成してください。</span><br><span class="line"></span><br><span class="line">Swagger で記述された REST API 定義</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"># NOTE: ここに OpenAPI 仕様を入れる</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">PlantUML のシーケンス図</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"># NOTE: ここに PlantUML のシーケンス図を入れる</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">PlantUML のクラス図</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"># NOTE: ここに PlantUML のクラス図を入れる</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">私に解決策を与えるために、あなたはそれを段階的に検討することができます。</span><br><span class="line">オブジェクトの用途を想定してください。</span><br><span class="line">テストコードを意味のあるものにするために、テスト データ、スタブ、モック、ダミー、スパイなどのテスト ダブル、そしてテスト ケースを準備してください。</span><br><span class="line">モックを使用するために `from unittest.mock import patch` を使用して構いません。</span><br></pre></td></tr></table></figure>

<h3 id="モデル"><a href="#モデル" class="headerlink" title="モデル"></a>モデル</h3><p>本記事執筆時点では、以下のモデルが使用可能です。</p>
<ul>
<li>text-davinci-003</li>
<li>code-davinci-002</li>
<li>gpt-35-turbo</li>
</ul>
<p>プロンプトの理解力とコード生成力のバランスから、基本的に <code>text-davinci-003</code> を使用します。</p>
<h3 id="入出力インターフェース"><a href="#入出力インターフェース" class="headerlink" title="入出力インターフェース"></a>入出力インターフェース</h3><p>Azure OpenAI Service の <a target="_blank" rel="noopener" href="https://oai.azure.com/portal/">Azure OpenAI Studio</a> 内にある <a target="_blank" rel="noopener" href="https://oai.azure.com/portal/playground">Playground</a> を使用します。</p>
<h2 id="実行手順"><a href="#実行手順" class="headerlink" title="実行手順"></a>実行手順</h2><h3 id="1-プロンプトを作成・入力する"><a href="#1-プロンプトを作成・入力する" class="headerlink" title="1. プロンプトを作成・入力する"></a>1. プロンプトを作成・入力する</h3><p>上記のプロンプトを完成させ、Playground に貼り付けます。</p>
<h3 id="2-Generate-ボタンを押す"><a href="#2-Generate-ボタンを押す" class="headerlink" title="2. Generate ボタンを押す"></a>2. Generate ボタンを押す</h3><p>何も生成されなくなるまで、 <code>Generate</code> し続けます。</p>
<h3 id="3-生成されたコードを取得する"><a href="#3-生成されたコードを取得する" class="headerlink" title="3. 生成されたコードを取得する"></a>3. 生成されたコードを取得する</h3><p>コピーしてエディタ等に貼り付けます。</p>
<h3 id="4-プロンプトの修正と実行を繰り返す"><a href="#4-プロンプトの修正と実行を繰り返す" class="headerlink" title="4. プロンプトの修正と実行を繰り返す"></a>4. プロンプトの修正と実行を繰り返す</h3><p><code>Temperture</code> がデフォルトでは <code>1</code> となっており、ゆらぎが大きいため、基本的には実行する度に異なる結果となります。<br>本記事ではあえて <code>1</code> のままにしています。<br>最良の結果が得られるまで繰り返し実行し、試行錯誤します。</p>
<h2 id="結果"><a href="#結果" class="headerlink" title="結果"></a>結果</h2><p>生成されたテストコードの中で一番良かったのは以下のコードでした。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> unittest</span><br><span class="line"><span class="keyword">from</span> unittest.mock <span class="keyword">import</span> patch</span><br><span class="line"></span><br><span class="line"><span class="comment"># Test data</span></span><br><span class="line">pets = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;id&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Fluffy&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;cat&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;tag&#x27;</span>: <span class="string">&#x27;feline&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;id&#x27;</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Fido&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;dog&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;tag&#x27;</span>: <span class="string">&#x27;canine&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">orders = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;id&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">&#x27;user_id&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">&#x27;pet_id&#x27;</span>: <span class="number">1</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;id&#x27;</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="string">&#x27;user_id&#x27;</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="string">&#x27;pet_id&#x27;</span>: <span class="number">2</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Test doubles</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PetStoreUI</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_pets</span>(<span class="params">self, tags, limit</span>):</span><br><span class="line">        <span class="keyword">return</span> pets</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_pet_by_id</span>(<span class="params">self, pet_id</span>):</span><br><span class="line">        <span class="keyword">for</span> pet <span class="keyword">in</span> pets:</span><br><span class="line">            <span class="keyword">if</span> pet[<span class="string">&#x27;id&#x27;</span>] == pet_id:</span><br><span class="line">                <span class="keyword">return</span> pet</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_pet</span>(<span class="params">self, pet</span>):</span><br><span class="line">        pets.append(pet)</span><br><span class="line">        <span class="keyword">return</span> pet</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">delete_pet</span>(<span class="params">self, pet_id</span>):</span><br><span class="line">        <span class="keyword">for</span> pet <span class="keyword">in</span> pets:</span><br><span class="line">            <span class="keyword">if</span> pet[<span class="string">&#x27;id&#x27;</span>] == pet_id:</span><br><span class="line">                pets.remove(pet)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PetStoreAPI</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_pets</span>(<span class="params">self, tags, limit</span>):</span><br><span class="line">        <span class="keyword">return</span> pets</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_pet_by_id</span>(<span class="params">self, pet_id</span>):</span><br><span class="line">        <span class="keyword">for</span> pet <span class="keyword">in</span> pets:</span><br><span class="line">            <span class="keyword">if</span> pet[<span class="string">&#x27;id&#x27;</span>] == pet_id:</span><br><span class="line">                <span class="keyword">return</span> pet</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_pet</span>(<span class="params">self, pet</span>):</span><br><span class="line">        pets.append(pet)</span><br><span class="line">        <span class="keyword">return</span> pet</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">delete_pet</span>(<span class="params">self, pet_id</span>):</span><br><span class="line">        <span class="keyword">for</span> pet <span class="keyword">in</span> pets:</span><br><span class="line">            <span class="keyword">if</span> pet[<span class="string">&#x27;id&#x27;</span>] == pet_id:</span><br><span class="line">                pets.remove(pet)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Database</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">select_all_pets</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> pets</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">select_pet_by_id</span>(<span class="params">self, pet_id</span>):</span><br><span class="line">        <span class="keyword">for</span> pet <span class="keyword">in</span> pets:</span><br><span class="line">            <span class="keyword">if</span> pet[<span class="string">&#x27;id&#x27;</span>] == pet_id:</span><br><span class="line">                <span class="keyword">return</span> pet</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">insert_order</span>(<span class="params">self, user_id, pet_id, datetime, created_at, updated_at</span>):</span><br><span class="line">        orders.append(&#123;</span><br><span class="line">            <span class="string">&#x27;id&#x27;</span>: <span class="built_in">len</span>(orders) + <span class="number">1</span>,</span><br><span class="line">            <span class="string">&#x27;user_id&#x27;</span>: user_id,</span><br><span class="line">            <span class="string">&#x27;pet_id&#x27;</span>: pet_id</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">delete_pet</span>(<span class="params">self, pet_id</span>):</span><br><span class="line">        <span class="keyword">for</span> pet <span class="keyword">in</span> pets:</span><br><span class="line">            <span class="keyword">if</span> pet[<span class="string">&#x27;id&#x27;</span>] == pet_id:</span><br><span class="line">                pets.remove(pet)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Test cases</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TestPetStore</span>(unittest.TestCase):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setUp</span>(<span class="params">self</span>):</span><br><span class="line">        self.ui = PetStoreUI()</span><br><span class="line">        self.api = PetStoreAPI()</span><br><span class="line">        self.db = Database()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_find_pets</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># Arrange</span></span><br><span class="line">        tags = [<span class="string">&#x27;feline&#x27;</span>, <span class="string">&#x27;canine&#x27;</span>]</span><br><span class="line">        limit = <span class="number">10</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Act</span></span><br><span class="line">        result = self.ui.find_pets(tags, limit)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Assert</span></span><br><span class="line">        self.assertEqual(result, pets)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_find_pet_by_id</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># Arrange</span></span><br><span class="line">        pet_id = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Act</span></span><br><span class="line">        result = self.ui.find_pet_by_id(pet_id)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Assert</span></span><br><span class="line">        self.assertEqual(result, pets[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_add_pet</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># Arrange</span></span><br><span class="line">        pet = &#123;</span><br><span class="line">            <span class="string">&#x27;id&#x27;</span>: <span class="number">3</span>,</span><br><span class="line">            <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Buddy&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;dog&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;tag&#x27;</span>: <span class="string">&#x27;canine&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Act</span></span><br><span class="line">        result = self.ui.add_pet(pet)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Assert</span></span><br><span class="line">        self.assertEqual(result, pet)</span><br><span class="line">        self.assertEqual(pets[-<span class="number">1</span>], pet)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_delete_pet</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># Arrange</span></span><br><span class="line">        pet_id = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Act</span></span><br><span class="line">        self.ui.delete_pet(pet_id)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Assert</span></span><br><span class="line">        self.assertEqual(<span class="built_in">len</span>(pets), <span class="number">1</span>)</span><br><span class="line">        self.assertEqual(pets[<span class="number">0</span>], pets[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_add_pet_with_transaction</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># Arrange</span></span><br><span class="line">        pet = &#123;</span><br><span class="line">            <span class="string">&#x27;id&#x27;</span>: <span class="number">3</span>,</span><br><span class="line">            <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Buddy&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;dog&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;tag&#x27;</span>: <span class="string">&#x27;canine&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        user_id = <span class="number">1</span></span><br><span class="line">        pet_id = <span class="number">3</span></span><br><span class="line">        datetime = <span class="string">&#x27;2020-08-20&#x27;</span></span><br><span class="line">        created_at = <span class="string">&#x27;2020-08-20&#x27;</span></span><br><span class="line">        updated_at = <span class="string">&#x27;2020-08-20&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Act</span></span><br><span class="line">        <span class="keyword">with</span> patch.<span class="built_in">object</span>(self.db, <span class="string">&#x27;insert_order&#x27;</span>, return_value=<span class="literal">None</span>) <span class="keyword">as</span> mock_insert_order:</span><br><span class="line">            result = self.api.add_pet(pet)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Assert</span></span><br><span class="line">            mock_insert_order.assert_called_once_with(user_id, pet_id, datetime, created_at, updated_at)</span><br><span class="line">            self.assertEqual(result, pet)</span><br><span class="line">            self.assertEqual(pets[-<span class="number">1</span>], pet)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_delete_pet_with_transaction</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># Arrange</span></span><br><span class="line">        pet_id = <span class="number">1</span></span><br><span class="line">        user_id = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Act</span></span><br><span class="line">        <span class="keyword">with</span> patch.<span class="built_in">object</span>(self.db, <span class="string">&#x27;delete_pet&#x27;</span>, return_value=<span class="literal">None</span>) <span class="keyword">as</span> mock_delete_pet:</span><br><span class="line">            self.api.delete_pet(pet_id)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Assert</span></span><br><span class="line">            mock_delete_pet.assert_called_once_with(pet_id)</span><br><span class="line">            self.assertEqual(<span class="built_in">len</span>(pets), <span class="number">1</span>)</span><br><span class="line">            self.assertEqual(pets[<span class="number">0</span>], pets[<span class="number">1</span>])</span><br></pre></td></tr></table></figure>

<p>実は、上記のテストコードには続きがあり、 <code>test_add_pet_with_transaction_failure</code> というテストケースが定義されていました。<br>ただ、トークン数の上限に達し、コード生成が途中で終了していました。<br>参考までに、その内容は以下の通りです。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">test_add_pet_with_transaction_failure</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="comment"># Arrange</span></span><br><span class="line">    pet = &#123;</span><br><span class="line">        <span class="string">&#x27;id&#x27;</span>: <span class="number">3</span>,</span><br><span class="line">        <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Buddy&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;dog&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;tag&#x27;</span>: <span class="string">&#x27;canine&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    user_id = <span class="number">1</span></span><br><span class="line">    pet_id = <span class="number">3</span></span><br><span class="line">    datetime = <span class="string">&#x27;2020-08-20&#x27;</span></span><br><span class="line">    created_at = <span class="string">&#x27;2020-08-20&#x27;</span></span><br><span class="line">    updated_at = <span class="string">&#x27;2020-08-20&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Act</span></span><br><span class="line">    <span class="keyword">with</span> patch.<span class="built_in">object</span>(self.db, <span class="string">&#x27;insert_order&#x27;</span>, return_value=<span class="literal">None</span>) <span class="keyword">as</span> mock_insert_order:</span><br><span class="line">        <span class="keyword">with</span> patch.<span class="built_in">object</span>(self.db, <span class="string">&#x27;delete_pet&#x27;</span>, side_effect=Exception(<span class="string">&#x27;Unexpected error&#x27;</span>)) <span class="keyword">as</span> mock_delete_pet:</span><br><span class="line">            result = self.api.add_pet(pet)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Assert</span></span><br><span class="line">            mock_insert_order.assert_called_once_with(user_id, pet_id, datetime, created_at, updated_at)</span><br><span class="line">            mock_delete_pet.assert_called_once_with(pet_id)</span><br><span class="line">            self.assertEqual(result, <span class="literal">None</span>)</span><br><span class="line">            self.assertEqual(<span class="built_in">len</span>(pets), <span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<p>おそらく、この後に <code>self.assertEqual(pets[0], pets[1])</code> が続くと考えられますし、テストコードとしては一応成立してはいますが、不完全である可能性があるため、本検証においては本テストケースを除外しました。</p>
<h2 id="評価"><a href="#評価" class="headerlink" title="評価"></a>評価</h2><p>テストコードをテストするテストコードを書いても仕方ないので、テストコードのレビューを人が行う形式で評価します。</p>
<h3 id="良い点"><a href="#良い点" class="headerlink" title="良い点"></a>良い点</h3><ul>
<li>プロンプトでの指示通りに生成されている点:<ul>
<li><code>unittest</code> モジュールおよびその <code>patch</code> を使用している。</li>
<li>テストデータを用意している。</li>
<li><code>test_find_pets</code> の <code>limit = 10</code> など、想定に基づくアレンジが加えられている。</li>
<li><code>assert_called_once_with</code> を使い、的確に spy を使用している。</li>
<li>シーケンス図の内容とテストケースの内容が合致している。</li>
</ul>
</li>
<li><code>unittest.TestCase</code> を継承させたり <code>setUP</code> 関数を使ったりと、 <code>unittest</code> モジュールを的確に使用している。</li>
<li><a target="_blank" rel="noopener" href="https://automationpanda.com/2020/07/07/arrange-act-assert-a-pattern-for-writing-good-tests/">AAA (Arrange-Act-Assert) パターン</a>を使用している。</li>
<li>記法が Python でメジャーなものとなっている (スネークケースの命名やスペース 4個のインデント等)。</li>
</ul>
<h3 id="改善点"><a href="#改善点" class="headerlink" title="改善点"></a>改善点</h3><ul>
<li>プロンプトでの指示通りになっていない点:<ul>
<li>クラス図が一部しか考慮されていない。</li>
<li>OpenAPI 仕様が考慮されていないかもしれない。</li>
</ul>
</li>
<li>テストダブルとしてクラスが定義されているが、これはほぼ実装コードである。テストコードだけあればよく、ここまでは求めていない。また、実装コードに対するテストコードとしては、このままでは使えない。実装コードとしても、変数のスコープの関係から、そのまま流用はできない。</li>
<li>各所のコメントについて、記述内容を鑑みるに、これらは不要である。</li>
<li><code>datetime</code> 等の値が datetime ではない。</li>
<li>テストケースとしては足りていない。プロンプトで渡す情報を精緻化することで、テストケースも精緻化され、網羅的になることを期待。</li>
<li>トークン数制限を超過してしまった。</li>
</ul>
<h2 id="補足"><a href="#補足" class="headerlink" title="補足"></a>補足</h2><p><code>text-davinci-003</code> 以外に、 <code>code-davinci-002</code> と <code>gpt-35-turbo</code> のモデルでも生成を試みました。<br><code>code-davinci-002</code> はプロンプトの読解力で <code>text-davinci-003</code> に大きく劣る感触で、その出力は採用しませんでした。<br><code>gpt-35-turbo</code> はチャットで使われていることもあるためか、コメント行が大変おしゃべりです。そして、<code>import unittest</code> していなかったり、クラスを使用していなかったりと、テストコードとしてはいまいちでした。</p>
<h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/ja-jp/azure/cognitive-services/openai/overview">Azure OpenAI Service</a> を使ってドキュメント (OpenAPI 仕様, PlantUML のシーケンス図およびクラス図) からテストコードを生成し、その内容を評価しました。</p>
<p>個人的には期待以上のアウトプットが得られたと感じていますが、しかしながらまだ「コードスニペット」としての用途にしか使えないと評価しています。<br>プロンプトをチューニングしたりドキュメントを精緻化することでより良い結果が出てくることが期待されますが、本検証で問題となったように、トークン数制限に容易に到達してしまうことが想定されます。<br>今回使用したモデルよりも GPT-4 の方がトークン数制限が緩いので、トークン数制限はサービスの発展とともに解消されると思われます。</p>
<p>とはいえ、職業プログラマとしてはテストコードだけでなくドキュメントも作成するものなので、ドキュメントからこれだけの「コードスニペット」が生成されるだけでも、価値はあるのではないでしょうか。</p>
</div></header><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a class="post__tag__link" href="/tags/Azure/">Azure</a></li><li class="post__tag__item"><a class="post__tag__link" href="/tags/Azure-OpenAI-Service/">Azure OpenAI Service</a></li><li class="post__tag__item"><a class="post__tag__link" href="/tags/OpenAPI/">OpenAPI</a></li><li class="post__tag__item"><a class="post__tag__link" href="/tags/PlantUML/">PlantUML</a></li><li class="post__tag__item"><a class="post__tag__link" href="/tags/TDD/">TDD</a></li></ul></footer></article></main><footer class="foot"><div class="foot-copy">&copy; 2021 - 2023 kt.log<a class="icp-a" href="https://github.com/k14i" target="view_window">by kt (Keisuke Takahashi)</a></div></footer><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
ga('create','G-9XBBR7M7V2');
ga('send','pageview');</script>
<script src="/js/scroller.js"></script>

<script src="/js/main.js"></script>
</body></html>