<!DOCTYPE html><html lang="ja"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="alternative" href="/atom.xml" title="kt.log" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>Test code generation from Swagger and PlantUML with Azure OpenAI Service using PromptGenerator method #2 - kt.log</title>
<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="/js/fancybox/jquery.fancybox.min.css">
<!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]-->
<script src="/js/jquery-3.1.1.min.js"></script>

<script src="/js/fancybox/jquery.fancybox.min.js"></script>
<meta name="generator" content="Hexo 6.2.0"></head><body style="opacity:0"><header class="head"><h1 class="head-title u-fl"><a href="/">kt.log</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a class="head-nav__link" href="/archives">Articles</a></li><li class="head-nav__item"><a class="head-nav__link" href="/tags">Tags</a></li><li class="head-nav__item"><a class="head-nav__link" href="/links">Links</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"><time class="post__time" datetime="2023-04-12T08:24:07.000Z">2023-04-12 17:24:07</time><h1 class="post__title"><a href="/2023/04/12/Test-code-generation-from-Swagger-and-PlantUML-with-Azure-OpenAI-Service-using-PromptGenerator-method-2/">Test code generation from Swagger and PlantUML with Azure OpenAI Service using PromptGenerator method #2</a></h1><div class="post__main echo"><h1 id="PromptGenerator-メソッドによって最適化されたプロンプトを使って-Azure-OpenAI-Service-で-OpenAPI-と-PlantUML-からテストコードを生成する-2"><a href="#PromptGenerator-メソッドによって最適化されたプロンプトを使って-Azure-OpenAI-Service-で-OpenAPI-と-PlantUML-からテストコードを生成する-2" class="headerlink" title="PromptGenerator メソッドによって最適化されたプロンプトを使って Azure OpenAI Service で OpenAPI と PlantUML からテストコードを生成する #2"></a>PromptGenerator メソッドによって最適化されたプロンプトを使って Azure OpenAI Service で OpenAPI と PlantUML からテストコードを生成する #2</h1><p>前回、<a target="_blank" rel="noopener" href="https://learn.microsoft.com/ja-jp/azure/cognitive-services/openai/overview">Azure OpenAI Service</a> を使って、まず ChatGPT にプロンプトを生成させる PromptGenerator メソッドを用いてプロンプトのチューニングを行い、そのプロンプトを用いて前回同様のアプローチでテストコードを生成し、その内容を評価しました。</p>
<p>前回の大きな問題としては、テストダブルをテスト対象にまで使用していることでした。本記事では PromptGenerator の段階でこれを解決する試みを行います。</p>
<h2 id="ゴール"><a href="#ゴール" class="headerlink" title="ゴール"></a>ゴール</h2><ul>
<li>PromptGenerator メソッドを用いて、前回のプロンプトに代わる最適化されたプロンプトを生成する。</li>
<li>前項のプロンプトを使ってドキュメントからテストコードを生成し、その内容を評価する。</li>
<li>その際に、テスト対象にテストダブルを用いないようにする。</li>
</ul>
<h2 id="免責"><a href="#免責" class="headerlink" title="免責"></a>免責</h2><ul>
<li>本記事の内容は、執筆時点のものです。LLM の変化やゆらぎもあるため、再現性は保証されません。</li>
<li>本記事の内容は検証レベルのものです。完全な手法に関する情報を提供するものではありません。</li>
<li>本記事で使用する PlantUML は、細部まで作り込んでいるわけではありません。細かい部分で間違いがある可能性があります。</li>
</ul>
<h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h2><p><strong>GPT-3 を使うのをやめて、GPT-4 を使うことで、この問題を高い確率で解決することができます。</strong></p>
<h2 id="ストラテジー"><a href="#ストラテジー" class="headerlink" title="ストラテジー"></a>ストラテジー</h2><ol>
<li>PromptGenerator メソッドを使って、要件を追加する</li>
<li>前項のプロンプトを箇条書きにする</li>
<li>Few-shot として追加のインストラクションを行う</li>
<li>GPT-4 を使う</li>
</ol>
<h3 id="1-PromptGenerator-メソッドを使って、要件を追加する"><a href="#1-PromptGenerator-メソッドを使って、要件を追加する" class="headerlink" title="1. PromptGenerator メソッドを使って、要件を追加する"></a>1. PromptGenerator メソッドを使って、要件を追加する</h3><p>ゼロから PromptGenerator を行ったため、前回とは異なる質問が生成されており、前回の内容をそのまま適用できるわけではありませんでした。そのため、都度質問に回答していきます。<br>なお、このような再現性の問題を軽減または解消するため、今回は <code>Temperature</code> を 0 に変更しました。<br>初回プロンプトは前回と同様です。<br>最終的に 6 回のやり取りを行うことになりました。</p>
<h4 id="生成されたプロンプト-6"><a href="#生成されたプロンプト-6" class="headerlink" title="生成されたプロンプト #6"></a>生成されたプロンプト #6</h4><blockquote>
<p>a) Revised Prompt:<br>Generate unit test code in Python using the unittest framework and unittest.mock’s patch module for given text materials such as OpenAI Specifications (JSON or YAML), PlantUML sequence diagrams (PlantUML format), and PlantUML class diagrams (PlantUML format), following the PEP 8 coding standards. Aim for more than 90% code coverage, with 100% being preferred. Consider edge cases and error handling from the given materials step-by-step, and follow the AAA (Arrange-Act-Assert) style without including comments in the test code. Generate test cases and prepare test data step-by-step, allowing the user to specify test targets&#x2F;objectives based on the actors of the sequence diagrams. Base test cases on class diagrams first, then sequence diagrams, and finally OpenAPI specifications for API servers. Define immutable test data in the setUp method of the test class that inherits unittest.TestCase, and specify additional test data in test cases if needed. Use the @patch(‘…’) decorator for mocking instead of with patch(‘…’) as mock_foo: statement. Apply the spy test double pattern using the assert_called_once_with method of patch.object when applicable, and use the with patch.object(‘…’) as mock_foo: statement in spy test double pattern cases. Be mindful of token limitations and avoid exceeding them when generating test code. Never apply test doubles like stub, mock, and the rest for the test targets&#x2F;objectives. Ensure that the test code is MECE (mutually exclusive and collectively exhaustive), structured, organized, and clean.</p>
<p>b) Suggestions:</p>
<ul>
<li>Provide test case scenarios when using the revised prompt in another session</li>
<li>Ensure proper handling of exceptions and edge cases based on the given materials</li>
<li>Validate the test code against the desired code coverage</li>
<li>Follow the specified guidelines for test data, mocking, test double patterns, and coding style</li>
</ul>
<p>c) Questions:</p>
<ol>
<li>Are you satisfied with the revised prompt, or do you have any further changes or additions you’d like to make?</li>
</ol>
</blockquote>
<p>上記の Revised Prompt を使って、テストコード生成のためのプロンプトを作って実行します。</p>
<h4 id="テストコード生成結果"><a href="#テストコード生成結果" class="headerlink" title="テストコード生成結果"></a>テストコード生成結果</h4><p>5 回生成しましたが、結果としては、いずれにおいても <code>patch</code> がテスト対象に用いられていました。</p>
<h5 id="結果1"><a href="#結果1" class="headerlink" title="結果1"></a>結果1</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> unittest</span><br><span class="line"><span class="keyword">from</span> unittest.mock <span class="keyword">import</span> patch</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TestPetStoreAPI</span>(unittest.TestCase):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Test class for PetStore API&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setUp</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Set up immutable test data&quot;&quot;&quot;</span></span><br><span class="line">        self.user_id = <span class="number">1</span></span><br><span class="line">        self.pet_id = <span class="number">1</span></span><br><span class="line">        self.datetime = <span class="string">&#x27;2020-01-01 00:00:00&#x27;</span></span><br><span class="line">        self.created_at = <span class="string">&#x27;2020-01-01 00:00:00&#x27;</span></span><br><span class="line">        self.updated_at = <span class="string">&#x27;2020-01-01 00:00:00&#x27;</span></span><br><span class="line">        self.pet_response = &#123;</span><br><span class="line">            <span class="string">&#x27;id&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Fido&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;dog&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;tag&#x27;</span>: <span class="string">&#x27;pet&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        self.error_response = &#123;</span><br><span class="line">            <span class="string">&#x27;code&#x27;</span>: <span class="number">500</span>,</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;unexpected error&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_find_pets</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Test findPets API&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> patch(<span class="string">&#x27;petstore.findPets&#x27;</span>) <span class="keyword">as</span> mock_find_pets:</span><br><span class="line">            mock_find_pets.return_value = self.pet_response</span><br><span class="line">            response = petstore.findPets()</span><br><span class="line">            self.assertEqual(response, self.pet_response)</span><br><span class="line">            mock_find_pets.assert_called_once_with()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_find_pet_by_id</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Test findPetById API&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> patch(<span class="string">&#x27;petstore.findPetById&#x27;</span>) <span class="keyword">as</span> mock_find_pet_by_id:</span><br><span class="line">            mock_find_pet_by_id.return_value = self.pet_response</span><br><span class="line">            response = petstore.findPetById(self.pet_id)</span><br><span class="line">            self.assertEqual(response, self.pet_response)</span><br><span class="line">            mock_find_pet_by_id.assert_called_once_with(self.pet_id)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_add_pet_success</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Test addPet API success&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> patch(<span class="string">&#x27;petstore.addPet&#x27;</span>) <span class="keyword">as</span> mock_add_pet:</span><br><span class="line">            <span class="keyword">with</span> patch.<span class="built_in">object</span>(petstore, <span class="string">&#x27;db&#x27;</span>) <span class="keyword">as</span> mock_db:</span><br><span class="line">                mock_add_pet.return_value = self.pet_response</span><br><span class="line">                response = petstore.addPet(self.user_id, self.pet_id, self.datetime, self.created_at, self.updated_at)</span><br><span class="line">                self.assertEqual(response, self.pet_response)</span><br><span class="line">                mock_add_pet.assert_called_once_with(self.user_id, self.pet_id, self.datetime, self.created_at, self.updated_at)</span><br><span class="line">                mock_db.transaction.assert_called_once_with()</span><br><span class="line">                mock_db.INSERT.assert_called_once_with(<span class="string">&#x27;orders&#x27;</span>, self.user_id, self.pet_id, self.datetime, self.created_at, self.updated_at)</span><br><span class="line">                mock_db.DELETE.assert_called_once_with(<span class="string">&#x27;pets&#x27;</span>, self.pet_id)</span><br><span class="line">                mock_db.commit.assert_called_once_with()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_add_pet_failure</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Test addPet API failure&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> patch(<span class="string">&#x27;petstore.addPet&#x27;</span>) <span class="keyword">as</span> mock_add_pet:</span><br><span class="line">            <span class="keyword">with</span> patch.<span class="built_in">object</span>(petstore, <span class="string">&#x27;db&#x27;</span>) <span class="keyword">as</span> mock_db:</span><br><span class="line">                mock_add_pet.return_value = self.error_response</span><br><span class="line">                response = petstore.addPet(self.user_id, self.pet_id, self.datetime, self.created_at, self.updated_at)</span><br><span class="line">                self.assertEqual(response, self.error_response)</span><br><span class="line">                mock_add_pet.assert_called_once_with(self.user_id, self.pet_id, self.datetime, self.created_at, self.updated_at)</span><br><span class="line">                mock_db.transaction.assert_called_once_with()</span><br><span class="line">                mock_db.INSERT.assert_called_once_with(<span class="string">&#x27;orders&#x27;</span>, self.user_id, self.pet_id, self.datetime, self.created_at, self.updated_at)</span><br><span class="line">                mock_db.DELETE.assert_not_called()</span><br><span class="line">                mock_db.rollback.assert_called_once_with()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_delete_pet</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Test deletePet API&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> patch(<span class="string">&#x27;petstore.deletePet&#x27;</span>) <span class="keyword">as</span> mock_delete_pet:</span><br><span class="line">            <span class="keyword">with</span> patch.<span class="built_in">object</span>(petstore, <span class="string">&#x27;db&#x27;</span>) <span class="keyword">as</span> mock_db:</span><br><span class="line">                mock_delete_pet.return_value = <span class="literal">None</span></span><br><span class="line">                response = petstore.deletePet(self.user_id, self.pet_id)</span><br><span class="line">                self.assertEqual(response, <span class="literal">None</span>)</span><br><span class="line">                mock_delete_pet.assert_called_once_with(self.user_id, self.pet_id)</span><br><span class="line">                mock_db.DELETE.assert_called_once_with(<span class="string">&#x27;pets&#x27;</span>, self.pet_id)</span><br><span class="line">                mock_db.DELETE.assert_called_once_with(<span class="string">&#x27;orders&#x27;</span>, self.user_id, self.pet_id)</span><br></pre></td></tr></table></figure>

<h5 id="結果2"><a href="#結果2" class="headerlink" title="結果2"></a>結果2</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">mport unittest</span><br><span class="line"><span class="keyword">from</span> unittest.mock <span class="keyword">import</span> patch</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TestPetStoreAPI</span>(unittest.TestCase):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setUp</span>(<span class="params">self</span>):</span><br><span class="line">        self.user_id = <span class="number">1</span></span><br><span class="line">        self.pet_id = <span class="number">1</span></span><br><span class="line">        self.datetime = <span class="string">&#x27;2020-08-08T12:00:00Z&#x27;</span></span><br><span class="line">        self.created_at = <span class="string">&#x27;2020-08-08T12:00:00Z&#x27;</span></span><br><span class="line">        self.updated_at = <span class="string">&#x27;2020-08-08T12:00:00Z&#x27;</span></span><br><span class="line">        self.tags = [<span class="string">&#x27;cat&#x27;</span>, <span class="string">&#x27;dog&#x27;</span>]</span><br><span class="line">        self.limit = <span class="number">10</span></span><br><span class="line">        self.pet = &#123;</span><br><span class="line">            <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;test_pet&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;tag&#x27;</span>: <span class="string">&#x27;test_tag&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        self.pet_response = [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&#x27;id&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">                <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;test_pet&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;test_type&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;tag&#x27;</span>: <span class="string">&#x27;test_tag&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">        self.error_model = &#123;</span><br><span class="line">            <span class="string">&#x27;code&#x27;</span>: <span class="number">500</span>,</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;unexpected error&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_find_pets</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">with</span> patch(<span class="string">&#x27;petstore.findPets&#x27;</span>) <span class="keyword">as</span> mock_find_pets:</span><br><span class="line">            mock_find_pets.return_value = self.pet_response</span><br><span class="line">            response = petstore.findPets(tags=self.tags, limit=self.limit)</span><br><span class="line">            self.assertEqual(response, self.pet_response)</span><br><span class="line">            mock_find_pets.assert_called_once_with(tags=self.tags, limit=self.limit)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_find_pet_by_id</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">with</span> patch(<span class="string">&#x27;petstore.findPetById&#x27;</span>) <span class="keyword">as</span> mock_find_pet_by_id:</span><br><span class="line">            mock_find_pet_by_id.return_value = self.pet_response</span><br><span class="line">            response = petstore.findPetById(pet_id=self.pet_id)</span><br><span class="line">            self.assertEqual(response, self.pet_response)</span><br><span class="line">            mock_find_pet_by_id.assert_called_once_with(pet_id=self.pet_id)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_add_pet</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">with</span> patch(<span class="string">&#x27;petstore.addPet&#x27;</span>) <span class="keyword">as</span> mock_add_pet:</span><br><span class="line">            mock_add_pet.return_value = self.pet_response</span><br><span class="line">            response = petstore.addPet(pet=self.pet)</span><br><span class="line">            self.assertEqual(response, self.pet_response)</span><br><span class="line">            mock_add_pet.assert_called_once_with(pet=self.pet)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_delete_pet</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">with</span> patch(<span class="string">&#x27;petstore.deletePet&#x27;</span>) <span class="keyword">as</span> mock_delete_pet:</span><br><span class="line">            mock_delete_pet.return_value = <span class="literal">None</span></span><br><span class="line">            response = petstore.deletePet(pet_id=self.pet_id)</span><br><span class="line">            self.assertIsNone(response)</span><br><span class="line">            mock_delete_pet.assert_called_once_with(pet_id=self.pet_id)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_add_pet_failure</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">with</span> patch(<span class="string">&#x27;petstore.addPet&#x27;</span>) <span class="keyword">as</span> mock_add_pet:</span><br><span class="line">            mock_add_pet.return_value = self.error_model</span><br><span class="line">            response = petstore.addPet(pet=self.pet)</span><br><span class="line">            self.assertEqual(response, self.error_model)</span><br><span class="line">            mock_add_pet.assert_called_once_with(pet=self.pet)</span><br></pre></td></tr></table></figure>

<h5 id="結果3"><a href="#結果3" class="headerlink" title="結果3"></a>結果3</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> unittest</span><br><span class="line"><span class="keyword">from</span> unittest.mock <span class="keyword">import</span> patch</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TestPetStoreAPI</span>(unittest.TestCase):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setUp</span>(<span class="params">self</span>):</span><br><span class="line">        self.user_id = <span class="number">1</span></span><br><span class="line">        self.pet_id = <span class="number">1</span></span><br><span class="line">        self.datetime = <span class="string">&#x27;2020-01-01T00:00:00&#x27;</span></span><br><span class="line">        self.created_at = <span class="string">&#x27;2020-01-01T00:00:00&#x27;</span></span><br><span class="line">        self.updated_at = <span class="string">&#x27;2020-01-01T00:00:00&#x27;</span></span><br><span class="line">        self.pet_list = [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&#x27;id&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">                <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;pet1&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;dog&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;tag&#x27;</span>: <span class="string">&#x27;cute&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&#x27;id&#x27;</span>: <span class="number">2</span>,</span><br><span class="line">                <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;pet2&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;cat&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;tag&#x27;</span>: <span class="string">&#x27;playful&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">        self.pet_detail = &#123;</span><br><span class="line">            <span class="string">&#x27;id&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;pet1&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;dog&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;tag&#x27;</span>: <span class="string">&#x27;cute&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        self.pet_data = &#123;</span><br><span class="line">            <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;pet3&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;tag&#x27;</span>: <span class="string">&#x27;lazy&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        self.pet_response = &#123;</span><br><span class="line">            <span class="string">&#x27;id&#x27;</span>: <span class="number">3</span>,</span><br><span class="line">            <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;pet3&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;dog&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;tag&#x27;</span>: <span class="string">&#x27;lazy&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        self.error_response = &#123;</span><br><span class="line">            <span class="string">&#x27;code&#x27;</span>: <span class="number">500</span>,</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;unexpected error&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&#x27;petstore.findPets&#x27;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_find_pets</span>(<span class="params">self, mock_find_pets</span>):</span><br><span class="line">        mock_find_pets.return_value = self.pet_list</span><br><span class="line">        response = petstore.findPets()</span><br><span class="line">        self.assertEqual(response, self.pet_list)</span><br><span class="line">        mock_find_pets.assert_called_once_with()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&#x27;petstore.findPetById&#x27;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_find_pet_by_id</span>(<span class="params">self, mock_find_pet_by_id</span>):</span><br><span class="line">        mock_find_pet_by_id.return_value = self.pet_detail</span><br><span class="line">        response = petstore.findPetById(self.pet_id)</span><br><span class="line">        self.assertEqual(response, self.pet_detail)</span><br><span class="line">        mock_find_pet_by_id.assert_called_once_with(self.pet_id)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&#x27;petstore.addPet&#x27;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_add_pet</span>(<span class="params">self, mock_add_pet</span>):</span><br><span class="line">        mock_add_pet.return_value = self.pet_response</span><br><span class="line">        response = petstore.addPet(self.pet_data)</span><br><span class="line">        self.assertEqual(response, self.pet_response)</span><br><span class="line">        mock_add_pet.assert_called_once_with(self.pet_data)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&#x27;petstore.deletePet&#x27;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_delete_pet</span>(<span class="params">self, mock_delete_pet</span>):</span><br><span class="line">        mock_delete_pet.return_value = <span class="literal">None</span></span><br><span class="line">        response = petstore.deletePet(self.pet_id)</span><br><span class="line">        self.assertIsNone(response)</span><br><span class="line">        mock_delete_pet.assert_called_once_with(self.pet_id)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&#x27;petstore.addPet&#x27;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_add_pet_failure</span>(<span class="params">self, mock_add_pet</span>):</span><br><span class="line">        mock_add_pet.return_value = self.error_response</span><br><span class="line">        response = petstore.addPet(self.pet_data)</span><br><span class="line">        self.assertEqual(response, self.error_response)</span><br><span class="line">        mock_add_pet.assert_called_once_with(self.pet_data)</span><br></pre></td></tr></table></figure>

<h5 id="結果4"><a href="#結果4" class="headerlink" title="結果4"></a>結果4</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> unittest</span><br><span class="line"><span class="keyword">from</span> unittest.mock <span class="keyword">import</span> patch</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TestPetStoreAPI</span>(unittest.TestCase):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setUp</span>(<span class="params">self</span>):</span><br><span class="line">        self.user_id = <span class="number">1</span></span><br><span class="line">        self.pet_id = <span class="number">1</span></span><br><span class="line">        self.datetime = <span class="string">&#x27;2020-01-01 00:00:00&#x27;</span></span><br><span class="line">        self.created_at = <span class="string">&#x27;2020-01-01 00:00:00&#x27;</span></span><br><span class="line">        self.updated_at = <span class="string">&#x27;2020-01-01 00:00:00&#x27;</span></span><br><span class="line">        self.pet_name = <span class="string">&#x27;dog&#x27;</span></span><br><span class="line">        self.pet_type = <span class="string">&#x27;dog&#x27;</span></span><br><span class="line">        self.pet_tag = <span class="string">&#x27;dog&#x27;</span></span><br><span class="line">        self.pet_list = [&#123;<span class="string">&#x27;id&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;dog&#x27;</span>, <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;dog&#x27;</span>, <span class="string">&#x27;tag&#x27;</span>: <span class="string">&#x27;dog&#x27;</span>&#125;]</span><br><span class="line">        self.pet_response = &#123;<span class="string">&#x27;id&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;dog&#x27;</span>, <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;dog&#x27;</span>, <span class="string">&#x27;tag&#x27;</span>: <span class="string">&#x27;dog&#x27;</span>&#125;</span><br><span class="line">        self.error_response = &#123;<span class="string">&#x27;code&#x27;</span>: <span class="number">500</span>, <span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;unexpected error&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&#x27;petstore.findPets&#x27;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_find_pets</span>(<span class="params">self, mock_find_pets</span>):</span><br><span class="line">        mock_find_pets.return_value = self.pet_list</span><br><span class="line">        result = petstore.findPets()</span><br><span class="line">        self.assertEqual(result, self.pet_list)</span><br><span class="line">        mock_find_pets.assert_called_once_with()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&#x27;petstore.findPetById&#x27;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_find_pet_by_id</span>(<span class="params">self, mock_find_pet_by_id</span>):</span><br><span class="line">        mock_find_pet_by_id.return_value = self.pet_response</span><br><span class="line">        result = petstore.findPetById(self.pet_id)</span><br><span class="line">        self.assertEqual(result, self.pet_response)</span><br><span class="line">        mock_find_pet_by_id.assert_called_once_with(self.pet_id)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&#x27;petstore.addPet&#x27;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_add_pet</span>(<span class="params">self, mock_add_pet</span>):</span><br><span class="line">        mock_add_pet.return_value = self.pet_response</span><br><span class="line">        result = petstore.addPet(self.user_id, self.pet_id, self.datetime, self.created_at, self.updated_at)</span><br><span class="line">        self.assertEqual(result, self.pet_response)</span><br><span class="line">        mock_add_pet.assert_called_once_with(self.user_id, self.pet_id, self.datetime, self.created_at, self.updated_at)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&#x27;petstore.deletePet&#x27;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_delete_pet</span>(<span class="params">self, mock_delete_pet</span>):</span><br><span class="line">        mock_delete_pet.return_value = <span class="literal">None</span></span><br><span class="line">        result = petstore.deletePet(self.pet_id)</span><br><span class="line">        self.assertIsNone(result)</span><br><span class="line">        mock_delete_pet.assert_called_once_with(self.pet_id)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&#x27;petstore.addPet&#x27;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_add_pet_failure</span>(<span class="params">self, mock_add_pet</span>):</span><br><span class="line">        mock_add_pet.return_value = self.error_response</span><br><span class="line">        result = petstore.addPet(self.user_id, self.pet_id, self.datetime, self.created_at, self.updated_at)</span><br><span class="line">        self.assertEqual(result, self.error_response)</span><br><span class="line">        mock_add_pet.assert_called_once_with(self.user_id, self.pet_id, self.datetime, self.created_at, self.updated_at)</span><br></pre></td></tr></table></figure>

<h5 id="結果5"><a href="#結果5" class="headerlink" title="結果5"></a>結果5</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> unittest</span><br><span class="line"><span class="keyword">from</span> unittest.mock <span class="keyword">import</span> patch</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TestPetStoreAPI</span>(unittest.TestCase):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setUp</span>(<span class="params">self</span>):</span><br><span class="line">        self.user_id = <span class="number">1</span></span><br><span class="line">        self.pet_id = <span class="number">1</span></span><br><span class="line">        self.datetime = <span class="string">&#x27;2020-01-01T00:00:00Z&#x27;</span></span><br><span class="line">        self.created_at = <span class="string">&#x27;2020-01-01T00:00:00Z&#x27;</span></span><br><span class="line">        self.updated_at = <span class="string">&#x27;2020-01-01T00:00:00Z&#x27;</span></span><br><span class="line">        self.pet_list = [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&#x27;id&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">                <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;dog&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;dog&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;tag&#x27;</span>: <span class="string">&#x27;dog&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&#x27;id&#x27;</span>: <span class="number">2</span>,</span><br><span class="line">                <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;cat&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;cat&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;tag&#x27;</span>: <span class="string">&#x27;cat&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">        self.pet_detail = &#123;</span><br><span class="line">            <span class="string">&#x27;id&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;dog&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;dog&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;tag&#x27;</span>: <span class="string">&#x27;dog&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        self.new_pet = &#123;</span><br><span class="line">            <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;rabbit&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;rabbit&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;tag&#x27;</span>: <span class="string">&#x27;rabbit&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        self.error_model = &#123;</span><br><span class="line">            <span class="string">&#x27;code&#x27;</span>: <span class="number">500</span>,</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;unexpected error&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_find_pets</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">with</span> patch(<span class="string">&#x27;petstore.api.findPets&#x27;</span>) <span class="keyword">as</span> mock_find_pets:</span><br><span class="line">            mock_find_pets.return_value = self.pet_list</span><br><span class="line">            response = mock_find_pets()</span><br><span class="line">            self.assertEqual(response, self.pet_list)</span><br><span class="line">            mock_find_pets.assert_called_once_with()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_find_pet_by_id</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">with</span> patch(<span class="string">&#x27;petstore.api.findPetById&#x27;</span>) <span class="keyword">as</span> mock_find_pet_by_id:</span><br><span class="line">            mock_find_pet_by_id.return_value = self.pet_detail</span><br><span class="line">            response = mock_find_pet_by_id(self.pet_id)</span><br><span class="line">            self.assertEqual(response, self.pet_detail)</span><br><span class="line">            mock_find_pet_by_id.assert_called_once_with(self.pet_id)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_add_pet_success</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">with</span> patch(<span class="string">&#x27;petstore.api.addPet&#x27;</span>) <span class="keyword">as</span> mock_add_pet:</span><br><span class="line">            <span class="keyword">with</span> patch.<span class="built_in">object</span>(<span class="string">&#x27;petstore.api&#x27;</span>, <span class="string">&#x27;db&#x27;</span>) <span class="keyword">as</span> mock_db:</span><br><span class="line">                mock_add_pet.return_value = self.pet_detail</span><br><span class="line">                response = mock_add_pet(self.user_id, self.pet_id, self.datetime, self.created_at, self.updated_at)</span><br><span class="line">                self.assertEqual(response, self.pet_detail)</span><br><span class="line">                mock_add_pet.assert_called_once_with(self.user_id, self.pet_id, self.datetime, self.created_at, self.updated_at)</span><br><span class="line">                mock_db.transaction.assert_called_once_with()</span><br><span class="line">                mock_db.INSERT.assert_called_once_with(<span class="string">&#x27;orders&#x27;</span>, self.user_id, self.pet_id, self.datetime, self.created_at, self.updated_at)</span><br><span class="line">                mock_db.DELETE.assert_called_once_with(<span class="string">&#x27;pets&#x27;</span>, self.pet_id)</span><br><span class="line">                mock_db.commit.assert_called_once_with()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_add_pet_failure</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">with</span> patch(<span class="string">&#x27;petstore.api.addPet&#x27;</span>) <span class="keyword">as</span> mock_add_pet:</span><br><span class="line">            <span class="keyword">with</span> patch.<span class="built_in">object</span>(<span class="string">&#x27;petstore.api&#x27;</span>, <span class="string">&#x27;db&#x27;</span>) <span class="keyword">as</span> mock_db:</span><br><span class="line">                mock_add_pet.return_value = self.error_model</span><br><span class="line">                response = mock_add_pet(self.user_id, self.pet_id, self.datetime, self.created_at, self.updated_at)</span><br><span class="line">                self.assertEqual(response, self.error_model)</span><br><span class="line">                mock_add_pet.assert_called_once_with(self.user_id, self.pet_id, self.datetime, self.created_at, self.updated_at)</span><br><span class="line">                mock_db.transaction.assert_called_once_with()</span><br><span class="line">                mock_db.INSERT.assert_called_once_with(<span class="string">&#x27;orders&#x27;</span>, self.user_id, self.pet_id, self.datetime, self.created_at, self.updated_at)</span><br><span class="line">                mock_db.DELETE.assert_not_called()</span><br><span class="line">                mock_db.rollback.assert_called_once_with()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_delete_pet</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">with</span> patch(<span class="string">&#x27;petstore.api.deletePet&#x27;</span>) <span class="keyword">as</span> mock_delete_pet:</span><br><span class="line">            <span class="keyword">with</span> patch.<span class="built_in">object</span>(<span class="string">&#x27;petstore.api&#x27;</span>, <span class="string">&#x27;db&#x27;</span>) <span class="keyword">as</span> mock_db:</span><br><span class="line">                mock_delete_pet.return_value = <span class="literal">None</span></span><br><span class="line">                response = mock_delete_pet(self.user_id, self.pet_id)</span><br><span class="line">                self.assertEqual(response, <span class="literal">None</span>)</span><br><span class="line">                mock_delete_pet.assert_called_once_with(self.user_id, self.pet_id)</span><br><span class="line">                mock_db.DELETE.assert_called_once_with(<span class="string">&#x27;pets&#x27;</span>, self.pet_id)</span><br><span class="line">                mock_db.DELETE.assert_called_once_with(<span class="string">&#x27;orders&#x27;</span>, self.user_id, self.pet_id)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Completions call failed:<br>This model’s maximum context length is 4097 tokens, however you requested 4099 tokens (3999 in your prompt; 100 for the completion). Please reduce your prompt; or completion length.</p>
</blockquote>
<h3 id="2-前項のプロンプトを箇条書きにする"><a href="#2-前項のプロンプトを箇条書きにする" class="headerlink" title="2. 前項のプロンプトを箇条書きにする"></a>2. 前項のプロンプトを箇条書きにする</h3><p>Revised Prompt における要件が箇条書きになることで、より伝わりやすくなるかを検証しました。</p>
<p>PromptGenerator のプロンプトに対して、以下のようにフィードバックを行いました。</p>
<p>As my answer for your question 1, I would like you to organize and bulletize the revised prompt.</p>
<p>生成されたプロンプトは以下の通りです。</p>
<blockquote>
<p>a) Revised Prompt:<br>Generate unit test code in Python using the unittest framework and unittest.mock’s patch module for given text materials such as OpenAI Specifications (JSON or YAML), PlantUML sequence diagrams (PlantUML format), and PlantUML class diagrams (PlantUML format), following the PEP 8 coding standards.</p>
<p>Key aspects to consider:</p>
<ul>
<li>Aim for more than 90% code coverage, with 100% being preferred.</li>
<li>Consider edge cases and error handling from the given materials step-by-step.</li>
<li>Follow the AAA (Arrange-Act-Assert) style without including comments in the test code.</li>
<li>Generate test cases and prepare test data step-by-step, allowing the user to specify test targets&#x2F;objectives based on the actors of the sequence diagrams.</li>
<li>Base test cases on class diagrams first, then sequence diagrams, and finally OpenAPI specifications for API servers.</li>
<li>Define immutable test data in the setUp method of the test class that inherits unittest.TestCase, and specify additional test data in test cases if needed.</li>
<li>Use the @patch(‘…’) decorator for mocking instead of with patch(‘…’) as mock_foo: statement.</li>
<li>Apply the spy test double pattern using the assert_called_once_with method of patch.object when applicable, and use the with patch.object(‘…’) as mock_foo: statement in spy test double pattern cases.</li>
<li>Be mindful of token limitations and avoid exceeding them when generating test code.</li>
<li>Never apply test doubles like stub, mock, and the rest for the test targets&#x2F;objectives.</li>
<li>Ensure that the test code is MECE (mutually exclusive and collectively exhaustive), structured, organized, and clean.</li>
</ul>
<p>b) Suggestions:</p>
<ul>
<li>Provide test case scenarios when using the revised prompt in another session</li>
<li>Ensure proper handling of exceptions and edge cases based on the given materials</li>
<li>Validate the test code against the desired code coverage</li>
<li>Follow the specified guidelines for test data, mocking, test double patterns, and coding style</li>
</ul>
<p>c) Questions:</p>
<ol>
<li>Are you satisfied with the revised prompt, or do you have any further changes or additions you’d like to make?</li>
</ol>
</blockquote>
<h4 id="テストコード生成結果-1"><a href="#テストコード生成結果-1" class="headerlink" title="テストコード生成結果"></a>テストコード生成結果</h4><p>5 回生成しましたが、結果としては、いずれにおいても <code>patch</code> がテスト対象に用いられていました。</p>
<p>ただ、5 回中 4回、テスト対象をテストコードの冒頭で <code>import</code> してくれるようになったのは、小さな前進でした。</p>
<h5 id="結果1-1"><a href="#結果1-1" class="headerlink" title="結果1"></a>結果1</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> unittest</span><br><span class="line"><span class="keyword">from</span> unittest.mock <span class="keyword">import</span> patch</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TestPetStoreAPI</span>(unittest.TestCase):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setUp</span>(<span class="params">self</span>):</span><br><span class="line">        self.user_id = <span class="number">1</span></span><br><span class="line">        self.pet_id = <span class="number">1</span></span><br><span class="line">        self.datetime = <span class="string">&#x27;2020-01-01 00:00:00&#x27;</span></span><br><span class="line">        self.created_at = <span class="string">&#x27;2020-01-01 00:00:00&#x27;</span></span><br><span class="line">        self.updated_at = <span class="string">&#x27;2020-01-01 00:00:00&#x27;</span></span><br><span class="line">        self.pet_response = &#123;</span><br><span class="line">            <span class="string">&#x27;id&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;dog&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;dog&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;tag&#x27;</span>: <span class="string">&#x27;pet&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        self.error_response = &#123;</span><br><span class="line">            <span class="string">&#x27;code&#x27;</span>: <span class="number">500</span>,</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;unexpected error&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&#x27;petstore.findPets&#x27;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_find_pets</span>(<span class="params">self, mock_find_pets</span>):</span><br><span class="line">        mock_find_pets.return_value = self.pet_response</span><br><span class="line">        response = petstore.findPets()</span><br><span class="line">        self.assertEqual(response, self.pet_response)</span><br><span class="line">        mock_find_pets.assert_called_once_with()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&#x27;petstore.findPetById&#x27;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_find_pet_by_id</span>(<span class="params">self, mock_find_pet_by_id</span>):</span><br><span class="line">        mock_find_pet_by_id.return_value = self.pet_response</span><br><span class="line">        response = petstore.findPetById(self.pet_id)</span><br><span class="line">        self.assertEqual(response, self.pet_response)</span><br><span class="line">        mock_find_pet_by_id.assert_called_once_with(self.pet_id)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&#x27;petstore.addPet&#x27;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_add_pet</span>(<span class="params">self, mock_add_pet</span>):</span><br><span class="line">        mock_add_pet.return_value = self.pet_response</span><br><span class="line">        response = petstore.addPet(self.user_id, self.pet_id, self.datetime, self.created_at, self.updated_at)</span><br><span class="line">        self.assertEqual(response, self.pet_response)</span><br><span class="line">        mock_add_pet.assert_called_once_with(self.user_id, self.pet_id, self.datetime, self.created_at, self.updated_at)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&#x27;petstore.deletePet&#x27;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_delete_pet</span>(<span class="params">self, mock_delete_pet</span>):</span><br><span class="line">        mock_delete_pet.return_value = <span class="literal">None</span></span><br><span class="line">        response = petstore.deletePet(self.pet_id, self.user_id)</span><br><span class="line">        self.assertEqual(response, <span class="literal">None</span>)</span><br><span class="line">        mock_delete_pet.assert_called_once_with(self.pet_id, self.user_id)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&#x27;petstore.addPet&#x27;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_add_pet_failure</span>(<span class="params">self, mock_add_pet</span>):</span><br><span class="line">        mock_add_pet.return_value = self.error_response</span><br><span class="line">        response = petstore.addPet(self.user_id, self.pet_id, self.datetime, self.created_at, self.updated_at)</span><br><span class="line">        self.assertEqual(response, self.error_response)</span><br><span class="line">        mock_add_pet.assert_called_once_with(self.user_id, self.pet_id, self.datetime, self.created_at, self.updated_at)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    unittest.main()</span><br></pre></td></tr></table></figure>

<h5 id="結果2-1"><a href="#結果2-1" class="headerlink" title="結果2"></a>結果2</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> unittest</span><br><span class="line"><span class="keyword">from</span> unittest.mock <span class="keyword">import</span> patch</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> petstore_api <span class="keyword">import</span> PetStoreAPI</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TestPetStoreAPI</span>(unittest.TestCase):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Test cases for the PetStoreAPI class&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setUp</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Set up test data&quot;&quot;&quot;</span></span><br><span class="line">        self.user_id = <span class="number">1</span></span><br><span class="line">        self.pet_id = <span class="number">2</span></span><br><span class="line">        self.datetime = <span class="string">&#x27;2020-01-01T00:00:00Z&#x27;</span></span><br><span class="line">        self.created_at = <span class="string">&#x27;2020-01-01T00:00:00Z&#x27;</span></span><br><span class="line">        self.updated_at = <span class="string">&#x27;2020-01-01T00:00:00Z&#x27;</span></span><br><span class="line">        self.pet_list = [</span><br><span class="line">            &#123;<span class="string">&#x27;id&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;cat&#x27;</span>, <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;cat&#x27;</span>, <span class="string">&#x27;tag&#x27;</span>: <span class="string">&#x27;cute&#x27;</span>&#125;,</span><br><span class="line">            &#123;<span class="string">&#x27;id&#x27;</span>: <span class="number">2</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;dog&#x27;</span>, <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;dog&#x27;</span>, <span class="string">&#x27;tag&#x27;</span>: <span class="string">&#x27;loyal&#x27;</span>&#125;,</span><br><span class="line">            &#123;<span class="string">&#x27;id&#x27;</span>: <span class="number">3</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;fish&#x27;</span>, <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;fish&#x27;</span>, <span class="string">&#x27;tag&#x27;</span>: <span class="string">&#x27;colorful&#x27;</span>&#125;</span><br><span class="line">        ]</span><br><span class="line">        self.pet_detail = &#123;<span class="string">&#x27;id&#x27;</span>: <span class="number">2</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;dog&#x27;</span>, <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;dog&#x27;</span>, <span class="string">&#x27;tag&#x27;</span>: <span class="string">&#x27;loyal&#x27;</span>&#125;</span><br><span class="line">        self.pet_data = &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;rabbit&#x27;</span>, <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;rabbit&#x27;</span>, <span class="string">&#x27;tag&#x27;</span>: <span class="string">&#x27;furry&#x27;</span>&#125;</span><br><span class="line">        self.error_model = &#123;<span class="string">&#x27;code&#x27;</span>: <span class="number">500</span>, <span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;Internal Server Error&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_find_pets</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Test the findPets method&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> patch.<span class="built_in">object</span>(PetStoreAPI, <span class="string">&#x27;findPets&#x27;</span>, return_value=self.pet_list) <span class="keyword">as</span> mock_find_pets:</span><br><span class="line">            pet_store_api = PetStoreAPI()</span><br><span class="line">            response = pet_store_api.findPets()</span><br><span class="line">            mock_find_pets.assert_called_once_with()</span><br><span class="line">            self.assertEqual(response, self.pet_list)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_find_pet_by_id</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Test the findPetById method&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> patch.<span class="built_in">object</span>(PetStoreAPI, <span class="string">&#x27;findPetById&#x27;</span>, return_value=self.pet_detail) <span class="keyword">as</span> mock_find_pet_by_id:</span><br><span class="line">            pet_store_api = PetStoreAPI()</span><br><span class="line">            response = pet_store_api.findPetById(self.pet_id)</span><br><span class="line">            mock_find_pet_by_id.assert_called_once_with(self.pet_id)</span><br><span class="line">            self.assertEqual(response, self.pet_detail)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_add_pet</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Test the addPet method&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> patch.<span class="built_in">object</span>(PetStoreAPI, <span class="string">&#x27;addPet&#x27;</span>, return_value=self.pet_data) <span class="keyword">as</span> mock_add_pet:</span><br><span class="line">            pet_store_api = PetStoreAPI()</span><br><span class="line">            response = pet_store_api.addPet(self.pet_data)</span><br><span class="line">            mock_add_pet.assert_called_once_with(self.pet_data)</span><br><span class="line">            self.assertEqual(response, self.pet_data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_delete_pet</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Test the deletePet method&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> patch.<span class="built_in">object</span>(PetStoreAPI, <span class="string">&#x27;deletePet&#x27;</span>, return_value=<span class="literal">None</span>) <span class="keyword">as</span> mock_delete_pet:</span><br><span class="line">            pet_store_api = PetStoreAPI()</span><br><span class="line">            response = pet_store_api.deletePet(self.pet_id)</span><br><span class="line">            mock_delete_pet.assert_called_once_with(self.pet_id)</span><br><span class="line">            self.assertIsNone(response)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_add_pet_transaction_failure</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Test the addPet method when transaction fails&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> patch.<span class="built_in">object</span>(PetStoreAPI, <span class="string">&#x27;addPet&#x27;</span>, return_value=self.error_model) <span class="keyword">as</span> mock_add_pet:</span><br><span class="line">            pet_store_api = PetStoreAPI()</span><br><span class="line">            response = pet_store_api.addPet(self.pet_data)</span><br><span class="line">            mock_add_pet.assert_called_once_with(self.pet_data)</span><br><span class="line">            self.assertEqual(response, self.error_model)</span><br></pre></td></tr></table></figure>

<h5 id="結果3-1"><a href="#結果3-1" class="headerlink" title="結果3"></a>結果3</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> unittest</span><br><span class="line"><span class="keyword">from</span> unittest.mock <span class="keyword">import</span> patch</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> petstore_api <span class="keyword">import</span> PetStoreAPI</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TestPetStoreAPI</span>(unittest.TestCase):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setUp</span>(<span class="params">self</span>):</span><br><span class="line">        self.user_id = <span class="number">1</span></span><br><span class="line">        self.pet_id = <span class="number">1</span></span><br><span class="line">        self.datetime = <span class="string">&#x27;2020-01-01 00:00:00&#x27;</span></span><br><span class="line">        self.created_at = <span class="string">&#x27;2020-01-01 00:00:00&#x27;</span></span><br><span class="line">        self.updated_at = <span class="string">&#x27;2020-01-01 00:00:00&#x27;</span></span><br><span class="line">        self.pet = &#123;</span><br><span class="line">            <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Fido&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;dog&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;tag&#x27;</span>: <span class="string">&#x27;friendly&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        self.pet_list = [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&#x27;id&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">                <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Fido&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;dog&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;tag&#x27;</span>: <span class="string">&#x27;friendly&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&#x27;id&#x27;</span>: <span class="number">2</span>,</span><br><span class="line">                <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Mittens&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;cat&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;tag&#x27;</span>: <span class="string">&#x27;playful&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">        self.pet_response = &#123;</span><br><span class="line">            <span class="string">&#x27;code&#x27;</span>: <span class="number">200</span>,</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;pet response&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        self.error_response = &#123;</span><br><span class="line">            <span class="string">&#x27;code&#x27;</span>: <span class="number">500</span>,</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;unexpected error&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_find_pets</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Test findPets method of PetStoreAPI&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> patch.<span class="built_in">object</span>(PetStoreAPI, <span class="string">&#x27;findPets&#x27;</span>) <span class="keyword">as</span> mock_find_pets:</span><br><span class="line">            mock_find_pets.return_value = self.pet_list</span><br><span class="line">            pet_list = PetStoreAPI().findPets()</span><br><span class="line">            mock_find_pets.assert_called_once_with()</span><br><span class="line">            self.assertEqual(pet_list, self.pet_list)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_find_pet_by_id</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Test findPetById method of PetStoreAPI&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> patch.<span class="built_in">object</span>(PetStoreAPI, <span class="string">&#x27;findPetById&#x27;</span>) <span class="keyword">as</span> mock_find_pet_by_id:</span><br><span class="line">            mock_find_pet_by_id.return_value = self.pet</span><br><span class="line">            pet = PetStoreAPI().findPetById(self.pet_id)</span><br><span class="line">            mock_find_pet_by_id.assert_called_once_with(self.pet_id)</span><br><span class="line">            self.assertEqual(pet, self.pet)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_add_pet</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Test addPet method of PetStoreAPI&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> patch.<span class="built_in">object</span>(PetStoreAPI, <span class="string">&#x27;addPet&#x27;</span>) <span class="keyword">as</span> mock_add_pet:</span><br><span class="line">            mock_add_pet.return_value = self.pet_response</span><br><span class="line">            response = PetStoreAPI().addPet(self.user_id, self.pet_id, self.datetime, self.created_at, self.updated_at)</span><br><span class="line">            mock_add_pet.assert_called_once_with(self.user_id, self.pet_id, self.datetime, self.created_at, self.updated_at)</span><br><span class="line">            self.assertEqual(response, self.pet_response)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_delete_pet</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Test deletePet method of PetStoreAPI&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> patch.<span class="built_in">object</span>(PetStoreAPI, <span class="string">&#x27;deletePet&#x27;</span>) <span class="keyword">as</span> mock_delete_pet:</span><br><span class="line">            mock_delete_pet.return_value = self.pet_response</span><br><span class="line">            response = PetStoreAPI().deletePet(self.user_id, self.pet_id)</span><br><span class="line">            mock_delete_pet.assert_called_once_with(self.user_id, self.pet_id)</span><br><span class="line">            self.assertEqual(response, self.pet_response)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_add_pet_failure</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Test addPet method of PetStoreAPI with failure&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> patch.<span class="built_in">object</span>(PetStoreAPI, <span class="string">&#x27;addPet&#x27;</span>) <span class="keyword">as</span> mock_add_pet:</span><br><span class="line">            mock_add_pet.return_value = self.error_response</span><br><span class="line">            response = PetStoreAPI().addPet(self.user_id, self.pet_id, self.datetime, self.created_at, self.updated_at)</span><br><span class="line">            mock_add_pet.assert_called_once_with(self.user_id, self.pet_id, self.datetime, self.created_at, self.updated_at)</span><br><span class="line">            self.assertEqual(response, self.error_response)</span><br></pre></td></tr></table></figure>

<h5 id="結果4-1"><a href="#結果4-1" class="headerlink" title="結果4"></a>結果4</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> unittest</span><br><span class="line"><span class="keyword">from</span> unittest.mock <span class="keyword">import</span> patch</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TestPetStoreAPI</span>(unittest.TestCase):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setUp</span>(<span class="params">self</span>):</span><br><span class="line">        self.user_id = <span class="number">1</span></span><br><span class="line">        self.pet_id = <span class="number">1</span></span><br><span class="line">        self.datetime = <span class="string">&#x27;2020-10-01&#x27;</span></span><br><span class="line">        self.created_at = <span class="string">&#x27;2020-10-01&#x27;</span></span><br><span class="line">        self.updated_at = <span class="string">&#x27;2020-10-01&#x27;</span></span><br><span class="line">        self.tags = [<span class="string">&#x27;cat&#x27;</span>, <span class="string">&#x27;dog&#x27;</span>]</span><br><span class="line">        self.limit = <span class="number">10</span></span><br><span class="line">        self.pet = &#123;</span><br><span class="line">            <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Tom&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;tag&#x27;</span>: <span class="string">&#x27;cat&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&#x27;petstore.api.findPets&#x27;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_find_pets</span>(<span class="params">self, mock_find_pets</span>):</span><br><span class="line">        mock_find_pets.return_value = <span class="number">200</span>, <span class="string">&#x27;pet response&#x27;</span></span><br><span class="line">        status_code, response = petstore.api.findPets(self.tags, self.limit)</span><br><span class="line">        self.assertEqual(status_code, <span class="number">200</span>)</span><br><span class="line">        self.assertEqual(response, <span class="string">&#x27;pet response&#x27;</span>)</span><br><span class="line">        mock_find_pets.assert_called_once_with(self.tags, self.limit)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&#x27;petstore.api.findPetById&#x27;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_find_pet_by_id</span>(<span class="params">self, mock_find_pet_by_id</span>):</span><br><span class="line">        mock_find_pet_by_id.return_value = <span class="number">200</span>, <span class="string">&#x27;pet response&#x27;</span></span><br><span class="line">        status_code, response = petstore.api.findPetById(self.pet_id)</span><br><span class="line">        self.assertEqual(status_code, <span class="number">200</span>)</span><br><span class="line">        self.assertEqual(response, <span class="string">&#x27;pet response&#x27;</span>)</span><br><span class="line">        mock_find_pet_by_id.assert_called_once_with(self.pet_id)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&#x27;petstore.api.addPet&#x27;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_add_pet</span>(<span class="params">self, mock_add_pet</span>):</span><br><span class="line">        mock_add_pet.return_value = <span class="number">200</span>, <span class="string">&#x27;pet response&#x27;</span></span><br><span class="line">        status_code, response = petstore.api.addPet(self.pet)</span><br><span class="line">        self.assertEqual(status_code, <span class="number">200</span>)</span><br><span class="line">        self.assertEqual(response, <span class="string">&#x27;pet response&#x27;</span>)</span><br><span class="line">        mock_add_pet.assert_called_once_with(self.pet)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&#x27;petstore.api.deletePet&#x27;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_delete_pet</span>(<span class="params">self, mock_delete_pet</span>):</span><br><span class="line">        mock_delete_pet.return_value = <span class="number">204</span>, <span class="string">&#x27;pet deleted&#x27;</span></span><br><span class="line">        status_code, response = petstore.api.deletePet(self.pet_id)</span><br><span class="line">        self.assertEqual(status_code, <span class="number">204</span>)</span><br><span class="line">        self.assertEqual(response, <span class="string">&#x27;pet deleted&#x27;</span>)</span><br><span class="line">        mock_delete_pet.assert_called_once_with(self.pet_id)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&#x27;petstore.api.addPet&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&#x27;petstore.db.transaction&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&#x27;petstore.db.INSERT&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&#x27;petstore.db.DELETE&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&#x27;petstore.db.commit&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&#x27;petstore.db.rollback&#x27;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_add_pet_transaction_failure</span>(<span class="params">self, mock_rollback, mock_commit, mock_delete, mock_insert, mock_transaction, mock_add_pet</span>):</span><br><span class="line">        mock_add_pet.return_value = <span class="number">500</span>, <span class="string">&#x27;unexpected error&#x27;</span></span><br><span class="line">        mock_transaction.return_value = <span class="literal">None</span></span><br><span class="line">        mock_insert.return_value = <span class="literal">None</span></span><br><span class="line">        mock_delete.return_value = <span class="literal">None</span></span><br><span class="line">        mock_commit.return_value = <span class="literal">None</span></span><br><span class="line">        mock_rollback.return_value = <span class="literal">None</span></span><br><span class="line">        status_code, response = petstore.api.addPet(self.pet)</span><br><span class="line">        self.assertEqual(status_code, <span class="number">500</span>)</span><br><span class="line">        self.assertEqual(response, <span class="string">&#x27;unexpected error&#x27;</span>)</span><br><span class="line">        mock_add_pet.assert_called_once_with(self.pet)</span><br><span class="line">        mock_transaction.assert_called_once()</span><br><span class="line">        mock_insert.assert_called_once_with(<span class="string">&#x27;orders&#x27;</span>, self.user_id, self.pet_id, self.datetime, self.created_at, self.updated_at)</span><br><span class="line">        mock_delete.assert_called_once_with(<span class="string">&#x27;pets&#x27;</span>, self.pet_id)</span><br><span class="line">        mock_commit.assert_not_called()</span><br><span class="line">        mock_rollback.assert_called_once()</span><br></pre></td></tr></table></figure>

<h5 id="結果5-1"><a href="#結果5-1" class="headerlink" title="結果5"></a>結果5</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> unittest</span><br><span class="line"><span class="keyword">from</span> unittest.mock <span class="keyword">import</span> patch</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> petstore_api <span class="keyword">import</span> PetStoreAPI</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TestPetStoreAPI</span>(unittest.TestCase):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Test cases for the PetStoreAPI class&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setUp</span>(<span class="params">self</span>):</span><br><span class="line">        self.pet_store_api = PetStoreAPI()</span><br><span class="line">        self.user_id = <span class="number">1</span></span><br><span class="line">        self.pet_id = <span class="number">2</span></span><br><span class="line">        self.datetime = <span class="string">&#x27;2020-01-01T00:00:00Z&#x27;</span></span><br><span class="line">        self.created_at = <span class="string">&#x27;2020-01-01T00:00:00Z&#x27;</span></span><br><span class="line">        self.updated_at = <span class="string">&#x27;2020-01-01T00:00:00Z&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&#x27;petstore_api.PetStoreAPI.findPets&#x27;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_find_pets</span>(<span class="params">self, mock_find_pets</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Test the findPets method&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># Arrange</span></span><br><span class="line">        tags = [<span class="string">&#x27;dog&#x27;</span>, <span class="string">&#x27;cat&#x27;</span>]</span><br><span class="line">        limit = <span class="number">10</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Act</span></span><br><span class="line">        self.pet_store_api.findPets(tags, limit)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Assert</span></span><br><span class="line">        mock_find_pets.assert_called_once_with(tags, limit)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&#x27;petstore_api.PetStoreAPI.findPetById&#x27;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_find_pet_by_id</span>(<span class="params">self, mock_find_pet_by_id</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Test the findPetById method&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># Arrange</span></span><br><span class="line">        pet_id = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Act</span></span><br><span class="line">        self.pet_store_api.findPetById(pet_id)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Assert</span></span><br><span class="line">        mock_find_pet_by_id.assert_called_once_with(pet_id)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&#x27;petstore_api.PetStoreAPI.addPet&#x27;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_add_pet</span>(<span class="params">self, mock_add_pet</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Test the addPet method&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># Arrange</span></span><br><span class="line">        pet = &#123;</span><br><span class="line">            <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Fido&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;tag&#x27;</span>: <span class="string">&#x27;dog&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Act</span></span><br><span class="line">        self.pet_store_api.addPet(pet)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Assert</span></span><br><span class="line">        mock_add_pet.assert_called_once_with(pet)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&#x27;petstore_api.PetStoreAPI.deletePet&#x27;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_delete_pet</span>(<span class="params">self, mock_delete_pet</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Test the deletePet method&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># Arrange</span></span><br><span class="line">        pet_id = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Act</span></span><br><span class="line">        self.pet_store_api.deletePet(pet_id)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Assert</span></span><br><span class="line">        mock_delete_pet.assert_called_once_with(pet_id)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&#x27;petstore_api.PetStoreAPI.transaction&#x27;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_transaction_success</span>(<span class="params">self, mock_transaction</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Test the transaction method with successful transaction&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># Arrange</span></span><br><span class="line">        mock_transaction.return_value = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Act</span></span><br><span class="line">        result = self.pet_store_api.transaction(self.user_id, self.pet_id, self.datetime, self.created_at, self.updated_at)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Assert</span></span><br><span class="line">        mock_transaction.assert_called_once_with(self.user_id, self.pet_id, self.datetime, self.created_at, self.updated_at)</span><br><span class="line">        self.assertTrue(result)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&#x27;petstore_api.PetStoreAPI.transaction&#x27;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_transaction_failure</span>(<span class="params">self, mock_transaction</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Test the transaction method with failed transaction&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># Arrange</span></span><br><span class="line">        mock_transaction.return_value = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Act</span></span><br><span class="line">        result = self.pet_store_api.transaction(self.user_id, self.pet_id, self.datetime, self.created_at, self.updated_at)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Assert</span></span><br><span class="line">        mock_transaction.assert_called_once_with(self.user_id, self.pet_id, self.datetime, self.created_at, self.updated_at)</span><br><span class="line">        self.assertFalse(result)</span><br></pre></td></tr></table></figure>

<h3 id="3-Few-shot-として追加のインストラクションを行う"><a href="#3-Few-shot-として追加のインストラクションを行う" class="headerlink" title="3. Few-shot として追加のインストラクションを行う"></a>3. Few-shot として追加のインストラクションを行う</h3><p>Revised Prompt の後に、以下のインストラクションを追加しました。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">## Hint: When to use `patch` of `unittest.mock`:</span><br><span class="line"></span><br><span class="line">Given the test target/objective is &quot;Foo&quot; class that has two methods named &quot;bar&quot; and &quot;baz&quot;. The class is imported like `from foo import Foo` and instantiated as `self.foo = Foo()` in the `setUp` function.</span><br><span class="line">In `test_bar` test function, you do not mock `self.foo.bar` because it is the target/objective of the test case. You only mock `self.foo.baz` if needed in the test case.</span><br><span class="line">In `test_baz` test function, you do not mock `self.foo.baz` because it is the target/objective of the test case. You only mock `self.foo.bar` if needed in the test case.</span><br></pre></td></tr></table></figure>

<h4 id="テストコード生成結果-2"><a href="#テストコード生成結果-2" class="headerlink" title="テストコード生成結果"></a>テストコード生成結果</h4><p>以下のようなテストコードを生成するようになってしまいました。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> unittest</span><br><span class="line"><span class="keyword">from</span> unittest.mock <span class="keyword">import</span> patch</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> foo <span class="keyword">import</span> Foo</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TestFoo</span>(unittest.TestCase):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setUp</span>(<span class="params">self</span>):</span><br><span class="line">        self.foo = Foo()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&#x27;foo.Foo.baz&#x27;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_bar</span>(<span class="params">self, mock_baz</span>):</span><br><span class="line">        <span class="comment"># Arrange</span></span><br><span class="line">        expected = <span class="string">&#x27;bar&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Act</span></span><br><span class="line">        actual = self.foo.bar()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Assert</span></span><br><span class="line">        self.assertEqual(expected, actual)</span><br><span class="line">        mock_baz.assert_not_called()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&#x27;foo.Foo.bar&#x27;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_baz</span>(<span class="params">self, mock_bar</span>):</span><br><span class="line">        <span class="comment"># Arrange</span></span><br><span class="line">        expected = <span class="string">&#x27;baz&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Act</span></span><br><span class="line">        actual = self.foo.baz()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Assert</span></span><br><span class="line">        self.assertEqual(expected, actual)</span><br><span class="line">        mock_bar.assert_not_called()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    unittest.main()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> unittest</span><br><span class="line"><span class="keyword">from</span> unittest.mock <span class="keyword">import</span> patch</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> foo <span class="keyword">import</span> Foo</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TestFoo</span>(unittest.TestCase):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setUp</span>(<span class="params">self</span>):</span><br><span class="line">        self.foo = Foo()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_bar</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># Arrange</span></span><br><span class="line">        expected_result = <span class="string">&#x27;bar&#x27;</span></span><br><span class="line">        expected_params = &#123;<span class="string">&#x27;param1&#x27;</span>: <span class="string">&#x27;value1&#x27;</span>, <span class="string">&#x27;param2&#x27;</span>: <span class="string">&#x27;value2&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Act</span></span><br><span class="line">        result = self.foo.bar(**expected_params)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Assert</span></span><br><span class="line">        self.assertEqual(result, expected_result)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&#x27;foo.Foo.baz&#x27;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_baz</span>(<span class="params">self, mock_baz</span>):</span><br><span class="line">        <span class="comment"># Arrange</span></span><br><span class="line">        expected_result = <span class="string">&#x27;baz&#x27;</span></span><br><span class="line">        expected_params = &#123;<span class="string">&#x27;param1&#x27;</span>: <span class="string">&#x27;value1&#x27;</span>, <span class="string">&#x27;param2&#x27;</span>: <span class="string">&#x27;value2&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Act</span></span><br><span class="line">        result = self.foo.baz(**expected_params)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Assert</span></span><br><span class="line">        mock_baz.assert_called_once_with(**expected_params)</span><br><span class="line">        self.assertEqual(result, expected_result)</span><br></pre></td></tr></table></figure>

<p>そこで、試しに以下のインストラクションも追加してみましたが、結果は変わりませんでした。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">If you understand when to use `patch` of `unittest.mock`, forget the hint including `Foo`, `bar`, `baz`. Remember the instruction above again.</span><br></pre></td></tr></table></figure>

<h3 id="4-GPT-4-を使う"><a href="#4-GPT-4-を使う" class="headerlink" title="4. GPT-4 を使う"></a>4. GPT-4 を使う</h3><p>箇条書きにしたプロンプトを、GPT-4 (<code>gpt-4-32k</code>) で動かしました。</p>
<h4 id="テストコード生成結果-3"><a href="#テストコード生成結果-3" class="headerlink" title="テストコード生成結果"></a>テストコード生成結果</h4><p>結果は非常に良好でした。5 回中 4 回、 <code>patch</code> を正しい対象に適用してくれました。</p>
<p>気になる点としては、テストケースがこれまでの GPT-3 から明らかに減少していることでした。</p>
<h5 id="結果1-2"><a href="#結果1-2" class="headerlink" title="結果1"></a>結果1</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> unittest</span><br><span class="line"><span class="keyword">from</span> unittest.mock <span class="keyword">import</span> patch</span><br><span class="line"><span class="keyword">from</span> pet_store <span class="keyword">import</span> PetStoreAPI</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TestPetStoreAPI</span>(unittest.TestCase):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setUp</span>(<span class="params">self</span>):</span><br><span class="line">        self.api = PetStoreAPI()</span><br><span class="line">        self.sample_pet = &#123;<span class="string">&quot;id&quot;</span>: <span class="number">1</span>, <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Fluffy&quot;</span>, <span class="string">&quot;tag&quot;</span>: <span class="string">&quot;dog&quot;</span>&#125;</span><br><span class="line">        self.sample_pets = [</span><br><span class="line">            &#123;<span class="string">&quot;id&quot;</span>: <span class="number">1</span>, <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Fluffy&quot;</span>, <span class="string">&quot;tag&quot;</span>: <span class="string">&quot;dog&quot;</span>&#125;,</span><br><span class="line">            &#123;<span class="string">&quot;id&quot;</span>: <span class="number">2</span>, <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Whiskers&quot;</span>, <span class="string">&quot;tag&quot;</span>: <span class="string">&quot;cat&quot;</span>&#125;,</span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&quot;pet_store.PetStoreAPI._query_database&quot;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_find_pets</span>(<span class="params">self, mock_query_database</span>):</span><br><span class="line">        mock_query_database.return_value = self.sample_pets</span><br><span class="line">        response = self.api.find_pets()</span><br><span class="line">        self.assertEqual(response, self.sample_pets)</span><br><span class="line">        mock_query_database.assert_called_once_with(<span class="string">&quot;SELECT * FROM pets&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&quot;pet_store.PetStoreAPI._query_database&quot;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_find_pet_by_id</span>(<span class="params">self, mock_query_database</span>):</span><br><span class="line">        mock_query_database.return_value = self.sample_pet</span><br><span class="line">        response = self.api.find_pet_by_id(<span class="number">1</span>)</span><br><span class="line">        self.assertEqual(response, self.sample_pet)</span><br><span class="line">        mock_query_database.assert_called_once_with(<span class="string">&quot;SELECT * FROM pets WHERE id = 1&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&quot;pet_store.PetStoreAPI._execute_transaction&quot;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_add_pet</span>(<span class="params">self, mock_execute_transaction</span>):</span><br><span class="line">        mock_execute_transaction.return_value = self.sample_pet</span><br><span class="line">        response = self.api.add_pet(self.sample_pet)</span><br><span class="line">        self.assertEqual(response, self.sample_pet)</span><br><span class="line">        mock_execute_transaction.assert_called_once_with(</span><br><span class="line">            <span class="string">&quot;INSERT INTO pets (name, tag) VALUES (&#x27;Fluffy&#x27;, &#x27;dog&#x27;)&quot;</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&quot;pet_store.PetStoreAPI._execute_transaction&quot;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_delete_pet</span>(<span class="params">self, mock_execute_transaction</span>):</span><br><span class="line">        mock_execute_transaction.return_value = <span class="literal">None</span></span><br><span class="line">        self.api.delete_pet(<span class="number">1</span>)</span><br><span class="line">        mock_execute_transaction.assert_called_once_with(</span><br><span class="line">            <span class="string">&quot;DELETE FROM pets WHERE id = 1&quot;</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    unittest.main()</span><br></pre></td></tr></table></figure>

<h5 id="結果2-2"><a href="#結果2-2" class="headerlink" title="結果2"></a>結果2</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> unittest</span><br><span class="line"><span class="keyword">from</span> unittest.mock <span class="keyword">import</span> patch</span><br><span class="line"><span class="keyword">from</span> pet_store <span class="keyword">import</span> PetStoreAPI, Pet, Order</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TestPetStoreAPI</span>(unittest.TestCase):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setUp</span>(<span class="params">self</span>):</span><br><span class="line">        self.api = PetStoreAPI()</span><br><span class="line">        self.sample_pet = Pet(<span class="built_in">id</span>=<span class="number">1</span>, name=<span class="string">&quot;Fluffy&quot;</span>, tag=<span class="string">&quot;dog&quot;</span>)</span><br><span class="line">        self.sample_pets = [</span><br><span class="line">            Pet(<span class="built_in">id</span>=<span class="number">1</span>, name=<span class="string">&quot;Fluffy&quot;</span>, tag=<span class="string">&quot;dog&quot;</span>),</span><br><span class="line">            Pet(<span class="built_in">id</span>=<span class="number">2</span>, name=<span class="string">&quot;Whiskers&quot;</span>, tag=<span class="string">&quot;cat&quot;</span>),</span><br><span class="line">        ]</span><br><span class="line">        self.sample_order = Order(<span class="built_in">id</span>=<span class="number">1</span>, user_id=<span class="number">1</span>, pet_id=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&quot;pet_store.PetStoreAPI.find_pets&quot;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_find_pets</span>(<span class="params">self, mock_find_pets</span>):</span><br><span class="line">        mock_find_pets.return_value = self.sample_pets</span><br><span class="line">        response = self.api.find_pets()</span><br><span class="line">        self.assertEqual(response, self.sample_pets)</span><br><span class="line">        mock_find_pets.assert_called_once()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&quot;pet_store.PetStoreAPI.find_pet_by_id&quot;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_find_pet_by_id</span>(<span class="params">self, mock_find_pet_by_id</span>):</span><br><span class="line">        mock_find_pet_by_id.return_value = self.sample_pet</span><br><span class="line">        response = self.api.find_pet_by_id(<span class="number">1</span>)</span><br><span class="line">        self.assertEqual(response, self.sample_pet)</span><br><span class="line">        mock_find_pet_by_id.assert_called_once_with(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&quot;pet_store.PetStoreAPI.add_pet&quot;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_add_pet</span>(<span class="params">self, mock_add_pet</span>):</span><br><span class="line">        mock_add_pet.return_value = self.sample_pet</span><br><span class="line">        response = self.api.add_pet(self.sample_pet)</span><br><span class="line">        self.assertEqual(response, self.sample_pet)</span><br><span class="line">        mock_add_pet.assert_called_once_with(self.sample_pet)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&quot;pet_store.PetStoreAPI.delete_pet&quot;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_delete_pet</span>(<span class="params">self, mock_delete_pet</span>):</span><br><span class="line">        mock_delete_pet.return_value = <span class="literal">None</span></span><br><span class="line">        self.api.delete_pet(<span class="number">1</span>)</span><br><span class="line">        mock_delete_pet.assert_called_once_with(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    unittest.main()</span><br></pre></td></tr></table></figure>

<h5 id="結果3-2"><a href="#結果3-2" class="headerlink" title="結果3"></a>結果3</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> unittest</span><br><span class="line"><span class="keyword">from</span> unittest.mock <span class="keyword">import</span> patch</span><br><span class="line"><span class="keyword">from</span> pet_store <span class="keyword">import</span> PetStoreAPI</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TestPetStoreAPI</span>(unittest.TestCase):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setUp</span>(<span class="params">self</span>):</span><br><span class="line">        self.api = PetStoreAPI()</span><br><span class="line">        self.sample_pet = &#123;<span class="string">&quot;id&quot;</span>: <span class="number">1</span>, <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Fluffy&quot;</span>, <span class="string">&quot;tag&quot;</span>: <span class="string">&quot;dog&quot;</span>&#125;</span><br><span class="line">        self.sample_pets = [</span><br><span class="line">            &#123;<span class="string">&quot;id&quot;</span>: <span class="number">1</span>, <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Fluffy&quot;</span>, <span class="string">&quot;tag&quot;</span>: <span class="string">&quot;dog&quot;</span>&#125;,</span><br><span class="line">            &#123;<span class="string">&quot;id&quot;</span>: <span class="number">2</span>, <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Whiskers&quot;</span>, <span class="string">&quot;tag&quot;</span>: <span class="string">&quot;cat&quot;</span>&#125;,</span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&quot;pet_store.PetStoreAPI._query_database&quot;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_find_pets</span>(<span class="params">self, mock_query_database</span>):</span><br><span class="line">        mock_query_database.return_value = self.sample_pets</span><br><span class="line">        response = self.api.find_pets()</span><br><span class="line">        self.assertEqual(response, self.sample_pets)</span><br><span class="line">        mock_query_database.assert_called_once_with(<span class="string">&quot;SELECT * FROM pets&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&quot;pet_store.PetStoreAPI._query_database&quot;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_find_pet_by_id</span>(<span class="params">self, mock_query_database</span>):</span><br><span class="line">        mock_query_database.return_value = self.sample_pet</span><br><span class="line">        response = self.api.find_pet_by_id(<span class="number">1</span>)</span><br><span class="line">        self.assertEqual(response, self.sample_pet)</span><br><span class="line">        mock_query_database.assert_called_once_with(<span class="string">&quot;SELECT * FROM pets WHERE id = 1&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&quot;pet_store.PetStoreAPI._execute_transaction&quot;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_add_pet</span>(<span class="params">self, mock_execute_transaction</span>):</span><br><span class="line">        mock_execute_transaction.return_value = self.sample_pet</span><br><span class="line">        response = self.api.add_pet(self.sample_pet)</span><br><span class="line">        self.assertEqual(response, self.sample_pet)</span><br><span class="line">        mock_execute_transaction.assert_called_once_with(</span><br><span class="line">            <span class="string">&quot;INSERT INTO pets (name, tag) VALUES (&#x27;Fluffy&#x27;, &#x27;dog&#x27;)&quot;</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&quot;pet_store.PetStoreAPI._execute_transaction&quot;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_delete_pet</span>(<span class="params">self, mock_execute_transaction</span>):</span><br><span class="line">        mock_execute_transaction.return_value = <span class="literal">None</span></span><br><span class="line">        self.api.delete_pet(<span class="number">1</span>)</span><br><span class="line">        mock_execute_transaction.assert_called_once_with(</span><br><span class="line">            <span class="string">&quot;DELETE FROM pets WHERE id = 1&quot;</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    unittest.main()</span><br></pre></td></tr></table></figure>

<h5 id="結果4-2"><a href="#結果4-2" class="headerlink" title="結果4"></a>結果4</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> unittest</span><br><span class="line"><span class="keyword">from</span> unittest.mock <span class="keyword">import</span> patch</span><br><span class="line"><span class="keyword">from</span> pet_store <span class="keyword">import</span> PetStoreAPI</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TestPetStoreAPI</span>(unittest.TestCase):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setUp</span>(<span class="params">self</span>):</span><br><span class="line">        self.api = PetStoreAPI()</span><br><span class="line">        self.sample_pet = &#123;<span class="string">&quot;id&quot;</span>: <span class="number">1</span>, <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Fluffy&quot;</span>, <span class="string">&quot;tag&quot;</span>: <span class="string">&quot;dog&quot;</span>&#125;</span><br><span class="line">        self.sample_pets = [</span><br><span class="line">            &#123;<span class="string">&quot;id&quot;</span>: <span class="number">1</span>, <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Fluffy&quot;</span>, <span class="string">&quot;tag&quot;</span>: <span class="string">&quot;dog&quot;</span>&#125;,</span><br><span class="line">            &#123;<span class="string">&quot;id&quot;</span>: <span class="number">2</span>, <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Whiskers&quot;</span>, <span class="string">&quot;tag&quot;</span>: <span class="string">&quot;cat&quot;</span>&#125;,</span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&quot;pet_store.PetStoreAPI._query_database&quot;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_find_pets</span>(<span class="params">self, mock_query_database</span>):</span><br><span class="line">        mock_query_database.return_value = self.sample_pets</span><br><span class="line">        response = self.api.find_pets()</span><br><span class="line">        self.assertEqual(response, self.sample_pets)</span><br><span class="line">        mock_query_database.assert_called_once_with(<span class="string">&quot;SELECT * FROM pets&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&quot;pet_store.PetStoreAPI._query_database&quot;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_find_pet_by_id</span>(<span class="params">self, mock_query_database</span>):</span><br><span class="line">        mock_query_database.return_value = self.sample_pet</span><br><span class="line">        response = self.api.find_pet_by_id(<span class="number">1</span>)</span><br><span class="line">        self.assertEqual(response, self.sample_pet)</span><br><span class="line">        mock_query_database.assert_called_once_with(<span class="string">&quot;SELECT * FROM pets WHERE id = 1&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&quot;pet_store.PetStoreAPI._execute_transaction&quot;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_add_pet</span>(<span class="params">self, mock_execute_transaction</span>):</span><br><span class="line">        mock_execute_transaction.return_value = self.sample_pet</span><br><span class="line">        pet_data = &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Fluffy&quot;</span>, <span class="string">&quot;tag&quot;</span>: <span class="string">&quot;dog&quot;</span>&#125;</span><br><span class="line">        response = self.api.add_pet(pet_data)</span><br><span class="line">        self.assertEqual(response, self.sample_pet)</span><br><span class="line">        mock_execute_transaction.assert_called_once_with(</span><br><span class="line">            <span class="string">&quot;INSERT INTO pets (name, tag) VALUES (&#x27;Fluffy&#x27;, &#x27;dog&#x27;)&quot;</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&quot;pet_store.PetStoreAPI._execute_transaction&quot;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_delete_pet</span>(<span class="params">self, mock_execute_transaction</span>):</span><br><span class="line">        mock_execute_transaction.return_value = <span class="literal">None</span></span><br><span class="line">        self.api.delete_pet(<span class="number">1</span>)</span><br><span class="line">        mock_execute_transaction.assert_called_once_with(</span><br><span class="line">            <span class="string">&quot;DELETE FROM pets WHERE id = 1&quot;</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    unittest.main()</span><br></pre></td></tr></table></figure>

<h5 id="結果5-2"><a href="#結果5-2" class="headerlink" title="結果5"></a>結果5</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> unittest</span><br><span class="line"><span class="keyword">from</span> unittest.mock <span class="keyword">import</span> patch, MagicMock</span><br><span class="line"><span class="keyword">from</span> pet_store <span class="keyword">import</span> PetStoreAPI, Pet, Order</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TestPetStoreAPI</span>(unittest.TestCase):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setUp</span>(<span class="params">self</span>):</span><br><span class="line">        self.api = PetStoreAPI()</span><br><span class="line">        self.sample_pet = Pet(<span class="built_in">id</span>=<span class="number">1</span>, name=<span class="string">&quot;Fluffy&quot;</span>, tag=<span class="string">&quot;dog&quot;</span>)</span><br><span class="line">        self.sample_pets = [</span><br><span class="line">            Pet(<span class="built_in">id</span>=<span class="number">1</span>, name=<span class="string">&quot;Fluffy&quot;</span>, tag=<span class="string">&quot;dog&quot;</span>),</span><br><span class="line">            Pet(<span class="built_in">id</span>=<span class="number">2</span>, name=<span class="string">&quot;Whiskers&quot;</span>, tag=<span class="string">&quot;cat&quot;</span>),</span><br><span class="line">        ]</span><br><span class="line">        self.sample_order = Order(<span class="built_in">id</span>=<span class="number">1</span>, user_id=<span class="number">1</span>, pet_id=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&quot;pet_store.PetStoreAPI.get_pets_from_db&quot;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_find_pets</span>(<span class="params">self, mock_get_pets_from_db</span>):</span><br><span class="line">        mock_get_pets_from_db.return_value = self.sample_pets</span><br><span class="line">        response = self.api.find_pets()</span><br><span class="line">        self.assertEqual(response, self.sample_pets)</span><br><span class="line">        mock_get_pets_from_db.assert_called_once()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&quot;pet_store.PetStoreAPI.get_pet_by_id_from_db&quot;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_find_pet_by_id</span>(<span class="params">self, mock_get_pet_by_id_from_db</span>):</span><br><span class="line">        mock_get_pet_by_id_from_db.return_value = self.sample_pet</span><br><span class="line">        response = self.api.find_pet_by_id(<span class="number">1</span>)</span><br><span class="line">        self.assertEqual(response, self.sample_pet)</span><br><span class="line">        mock_get_pet_by_id_from_db.assert_called_once_with(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&quot;pet_store.PetStoreAPI.add_pet_to_db&quot;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_add_pet</span>(<span class="params">self, mock_add_pet_to_db</span>):</span><br><span class="line">        mock_add_pet_to_db.return_value = self.sample_pet</span><br><span class="line">        pet_data = &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Fluffy&quot;</span>, <span class="string">&quot;tag&quot;</span>: <span class="string">&quot;dog&quot;</span>&#125;</span><br><span class="line">        response = self.api.add_pet(pet_data)</span><br><span class="line">        self.assertEqual(response, self.sample_pet)</span><br><span class="line">        mock_add_pet_to_db.assert_called_once_with(pet_data)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @patch(<span class="params"><span class="string">&quot;pet_store.PetStoreAPI.delete_pet_from_db&quot;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_delete_pet</span>(<span class="params">self, mock_delete_pet_from_db</span>):</span><br><span class="line">        mock_delete_pet_from_db.return_value = <span class="literal">None</span></span><br><span class="line">        self.api.delete_pet(<span class="number">1</span>)</span><br><span class="line">        mock_delete_pet_from_db.assert_called_once_with(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    unittest.main()</span><br></pre></td></tr></table></figure>

<h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>テストダブルを正しく使うには、その意義を理解する必要があります。テスト対象そのものをモックすると、それはテストとして機能しません。<br>この概念を GPT-3 は持っていないようで、形式でしか判断できない様子でした。対応策として Few-shot を用いると、かえってそちらにバイアスがかかってしまい、PromptGenerator メソッドで生成したプロンプトの指示内容がほぼ無視されてしまう程でした。<br>それに対して、GPT-4 は高い確率で正しくモックの適用ができていて、この問題を乗り越えることができることが分かりました。</p>
<p>よって、テストコード生成には GPT-4 を使うことが事実上必須であると言えます。</p>
</div></header><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a class="post__tag__link" href="/tags/Azure/">Azure</a></li><li class="post__tag__item"><a class="post__tag__link" href="/tags/Azure-OpenAI-Service/">Azure OpenAI Service</a></li><li class="post__tag__item"><a class="post__tag__link" href="/tags/OpenAPI/">OpenAPI</a></li><li class="post__tag__item"><a class="post__tag__link" href="/tags/PlantUML/">PlantUML</a></li><li class="post__tag__item"><a class="post__tag__link" href="/tags/TDD/">TDD</a></li><li class="post__tag__item"><a class="post__tag__link" href="/tags/GPT-4/">GPT-4</a></li><li class="post__tag__item"><a class="post__tag__link" href="/tags/OpenAI/">OpenAI</a></li><li class="post__tag__item"><a class="post__tag__link" href="/tags/Prompt-engineering/">Prompt engineering</a></li><li class="post__tag__item"><a class="post__tag__link" href="/tags/GPT-3/">GPT-3</a></li></ul></footer></article></main><footer class="foot"><div class="foot-copy">&copy; 2021 - 2023 kt.log<a class="icp-a" href="https://github.com/k14i" target="view_window">by kt (Keisuke Takahashi)</a></div></footer><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
ga('create','G-9XBBR7M7V2');
ga('send','pageview');</script>
<script src="/js/scroller.js"></script>

<script src="/js/main.js"></script>
</body></html>